(window.webpackJsonp=window.webpackJsonp||[]).push([[49],{443:function(t,a,s){t.exports=s.p+"assets/img/coredata_ex_0.c2507e61.png"},444:function(t,a,s){t.exports=s.p+"assets/img/coredata_ex_1.ca6f2f1c.png"},667:function(t,a,s){"use strict";s.r(a);var e=s(5),n=Object(e.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("p",[t._v("最近项目中需要拓展一下已经定义好的实例字段，同时原本的实例是支持l iCoud 同步的，新增加实力(Entity)字段后，我们的预期是「"),a("strong",[t._v("老版本升级上来的用户能正常使用，同时还能正常进行 iCloud  同步")]),t._v("」，即用户对字段升级毫无感知。")]),t._v(" "),a("p",[t._v("这篇文章就介绍技术实现的具体细节。")]),t._v(" "),a("p",[t._v("这里还是用 "),a("code",[t._v("Student")]),t._v(" 学生这个实例来举例子，原始有 "),a("code",[t._v("age")]),t._v(", "),a("code",[t._v("name")]),t._v(", "),a("code",[t._v("school")]),t._v(" 三个属性，我们希望新增一个分数 "),a("code",[t._v("score")]),t._v(" 的属性。")]),t._v(" "),a("p",[t._v("Model 配置如图，Cloud 配置是云端配置，Student 已经配置在了 Cloud 中，具体的配置流程可以参考我之前的这篇文章 "),a("a",{attrs:{href:"https://fanthus.github.io/2022/11/25/coredata%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-4/",target:"_blank",rel:"noopener noreferrer"}},[t._v("CoreData+CloudKit使用流程"),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("p",[a("img",{attrs:{src:s(443),alt:"Untitled"}})]),t._v(" "),a("p",[t._v("对于一些比较简单的情况，Core Data通常可以执行自动数据迁移，称为轻量级迁移。轻量级迁移是通过源托管对象模型与目标托管对象模型之间的差异推断出的迁移。")]),t._v(" "),a("p",[t._v("我上面说的这种情况（添加一个属性）就可以使用轻量级的迁移方式，具体支持轻量级迁移方式的场景可以参考官方文档 "),a("a",{attrs:{href:"https://developer.apple.com/documentation/coredata/migrating_your_data_model_automatically",target:"_blank",rel:"noopener noreferrer"}},[t._v("CoreData-Migrating your data model automatically"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("这篇文章目前就只介绍轻量级迁移的方式，之后如果有需要再更新手动迁移的方式。")]),t._v(" "),a("p",[t._v("我们在 "),a("code",[t._v("AppDelegate")]),t._v(" 中 "),a("code",[t._v("NSPersistentCloudKitContainer")]),t._v(" 配置的地方，增加如下两行加粗代码")]),t._v(" "),a("div",{staticClass:"language-swift extra-class"},[a("pre",{pre:!0,attrs:{class:"language-swift"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" container "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("NSPersistentCloudKitContainer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-literal"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"coredata_extend"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" cloudStoreDescription "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("NSPersistentStoreDescription")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("self")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cloudStorePath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ncloudStoreDescription"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cloudKitContainerOptions "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("NSPersistentCloudKitContainerOptions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("init")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("containerIdentifier"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-literal"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"iCloud.com.coredata_extend"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ncloudStoreDescription"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("configuration "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-literal"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Cloud"')])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//新增两行代码")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("**")]),t._v("cloudStoreDescription"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("shouldInferMappingModelAutomatically "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\ncloudStoreDescription"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("shouldMigrateStoreAutomatically "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("**")]),t._v("\ncontainer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("persistentStoreDescriptions "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" cloudStoreDescription "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),a("p",[t._v("介绍一下相关的两个属性")]),t._v(" "),a("ol",[a("li",[a("code",[t._v("shouldInferMappingModelAutomatically")]),t._v(" **：**如果将该标志设置为YES，协调器将尝试在找不到映射模型时推断一个。该标志的默认值为YES。")]),t._v(" "),a("li",[a("code",[t._v("shouldMigrateStoreAutomatically")]),t._v("： 这个标志位指是否应该自动迁移关联的持久化存储。如果将其设置为NO且本地存储没有和最新的数据模型同步，即两个新旧版本模型不一致，尝试加载本地存储将产生错误。如果将其设置为YES且存储不同步，尝试加载存储将导致Core Data尝试进行迁移。默认情况下，该标志设置为YES。")])]),t._v(" "),a("p",[t._v("配置后之后，我在视图点击方法里创建一个 Student 实例，配置上 score 属性值，然后正常进行保存。")]),t._v(" "),a("div",{staticClass:"language-swift extra-class"},[a("pre",{pre:!0,attrs:{class:"language-swift"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" stu "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Student")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" appDelegate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("persistentContainer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("viewContext"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nstu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-literal"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Liuyu"')])]),t._v("\nstu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("school "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-literal"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"WD"')])]),t._v("\nstu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("age "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v("\nstu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("score "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("19")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" appDelegate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("persistentContainer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("viewContext"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("save")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[t._v("在已经安装了旧版本 Model 的手机上，运行新代码，执行对应的实例创建方法。等一下在云端查看对应数据发现已经保存上了，如图")]),t._v(" "),a("p",[a("img",{attrs:{src:s(444),alt:"Untitled"}})]),t._v(" "),a("p",[t._v("同时如果老设备没有更新到带有新增属性的数据模型版本的话，也是能获取到最新的数据，并不会出现启动的时候因为属性不兼容导致的崩溃，只不过获取到的数据是没有新增属性的。")]),t._v(" "),a("p",[t._v("参考地址:")]),t._v(" "),a("ol",[a("li",[a("a",{attrs:{href:"https://developer.apple.com/documentation/coredata/migrating_your_data_model_automatically",target:"_blank",rel:"noopener noreferrer"}},[t._v("CoreData-Migrating your data model automatically"),a("OutboundLink")],1)])]),t._v(" "),a("Vssue",{attrs:{title:"CoreData实体增加属性并支持iCloud同步"}})],1)}),[],!1,null,null,null);a.default=n.exports}}]);