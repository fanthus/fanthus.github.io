(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{382:function(t,a,s){t.exports=s.p+"assets/img/coredata_project_init.6a084cd5.png"},383:function(t,a,s){t.exports=s.p+"assets/img/coredata_project_config.279858e7.png"},384:function(t,a,s){t.exports=s.p+"assets/img/coredata_config.5185766a.png"},385:function(t,a,s){t.exports=s.p+"assets/img/coredata_config_cloud.8597107f.png"},386:function(t,a,s){t.exports=s.p+"assets/img/coredata_config_local.b5af3fa3.png"},387:function(t,a,s){t.exports=s.p+"assets/img/coredata_sandbox.d3f1f656.png"},388:function(t,a,s){t.exports=s.p+"assets/img/coredata_cloudkit_console.73f84294.png"},628:function(t,a,s){"use strict";s.r(a);var n=s(5),e=Object(n.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("p",[t._v("这篇笔记主要是参考苹果官方文档的配置流程来介绍 CoreData 如何配置支持 CloudKit，按步骤介绍一下整体的流程")]),t._v(" "),a("h2",{attrs:{id:"创建工程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建工程"}},[t._v("#")]),t._v(" 创建工程")]),t._v(" "),a("p",[t._v("在创建工程的时候勾选使用 CoreData，以及 Host in iCloud，这样会在初始化 CoreData Stack 的时候直接使用 "),a("code",[t._v("NSPersistentCloudKitContainer")]),t._v(" 进行初始化，"),a("code",[t._v("NSPersistentCloudKitContainer")]),t._v(" 是 "),a("code",[t._v("NSPersistentContainer")]),t._v(" 子类，提供了管理 CloudKit 支持的存储和非云端的存储。")]),t._v(" "),a("p",[a("img",{attrs:{src:s(382),alt:"coredata_project_init"}})]),t._v(" "),a("p",[t._v("对于已有的使用 CoreData 工程来说，也就是替换 "),a("code",[t._v("NSPersistentContainer")]),t._v(" 为 "),a("code",[t._v("NSPersistentCloudKitContainer")]),t._v("。")]),t._v(" "),a("blockquote",[a("p",[t._v("对应的调试设备应该登录 iCloud 账户，并开启 iCloud Drive")])]),t._v(" "),a("h2",{attrs:{id:"配置工程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置工程"}},[t._v("#")]),t._v(" 配置工程")]),t._v(" "),a("p",[t._v("主要是一下两个配置")]),t._v(" "),a("ol",[a("li",[t._v("添加 iCloud Capability。然后在工程 Target 的 Signing & Capabilities → iCloud 部分开启 CloudKit 支持。并配置默认 Container")]),t._v(" "),a("li",[t._v("增加后台模式的支持。Background Modes → Remote notifications。这个目的是为了能实时收到云端数据变化的通知。")])]),t._v(" "),a("p",[a("img",{attrs:{src:s(383),alt:"coredata_project_config"}})]),t._v(" "),a("h2",{attrs:{id:"创建数据-model"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建数据-model"}},[t._v("#")]),t._v(" 创建数据 Model")]),t._v(" "),a("p",[t._v("和正常创建数据模型一样，在 CoreData 数据模型里创建对应的 Entity，如下")]),t._v(" "),a("p",[a("img",{attrs:{src:s(384),alt:"Untitled"}})]),t._v(" "),a("p",[t._v("这里创建了 "),a("code",[t._v("CloudEntity")]),t._v(" 和  "),a("code",[t._v("LocalEntity")]),t._v("，目的是只将本地数据的一部分镜像到 CloudKit，另外一部分只用本地存储。所以我们需要对创建的 model 进行配置，然后在不同的存储中组织数据，并决定将哪些存储同步到云端。")]),t._v(" "),a("p",[t._v("默认情况下是只有 Default 配置，这里我们增加了 Local 和 Cloud 的配置，Local 即是本地存储的配置，Cloud 是云端存储的配置。添加配置方式在 Editor → Add Configuration。")]),t._v(" "),a("p",[t._v("将需要同步到云端的数据实例(Entity)拖拽到对应 Cloud 配置里，本地数据实例同理拖拽到 Local 配置下。区分云端存储和非云端储存的工程端的配置如下")]),t._v(" "),a("p",[a("img",{attrs:{src:s(385),alt:"Untitled"}})]),t._v(" "),a("p",[a("img",{attrs:{src:s(386),alt:"Untitled"}})]),t._v(" "),a("h2",{attrs:{id:"配置-persistentcontainer"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置-persistentcontainer"}},[t._v("#")]),t._v(" 配置 PersistentContainer")]),t._v(" "),a("p",[t._v("这部分直接上代码")]),t._v(" "),a("div",{staticClass:"language-swift extra-class"},[a("pre",{pre:!0,attrs:{class:"language-swift"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 本地 Store 文件")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function-definition function"}},[t._v("localStorePath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("URL")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" path "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("NSSearchPathForDirectoriesInDomains")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("documentDirectory"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("userDomainMask"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("first"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NSURL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("init")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fileURLWithPath"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-literal"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"')]),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("\\(")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[t._v("path")]),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('/local.store"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" isDirectory"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("URL")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 云端 Store 文件")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function-definition function"}},[t._v("cloudStorePath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("URL")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" path "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("NSSearchPathForDirectoriesInDomains")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("documentDirectory"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("userDomainMask"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("first"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NSURL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("init")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fileURLWithPath"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-literal"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"')]),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("\\(")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[t._v("path")]),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('/cloud.store"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" isDirectory"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("URL")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("lazy")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" persistentContainer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("NSPersistentCloudKitContainer")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" container "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("NSPersistentCloudKitContainer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-literal"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"iCloudDemo"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//本地存储描述")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" localStoreDescription "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("NSPersistentStoreDescription")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("self")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("localStorePath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    localStoreDescription"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("configuration "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-literal"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Local"')])]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//云端存储描述")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" cloudStoreDescription "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("NSPersistentStoreDescription")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("self")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cloudStorePath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    cloudStoreDescription"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cloudKitContainerOptions "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("NSPersistentCloudKitContainerOptions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("init")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("containerIdentifier"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-literal"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"iCloud.com.perfectworld.cloudkitdemo"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//工程配置中配置的 containerId")]),t._v("\n    cloudStoreDescription"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("configuration "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-literal"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Cloud"')])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//实例配置部分的名字")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//为 persistentContainer 配置两个存储描述")]),t._v("\n    container"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("persistentStoreDescriptions "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        localStoreDescription"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        cloudStoreDescription\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive property"}},[a("span",{pre:!0,attrs:{class:"token directive-name"}},[t._v("#if")]),t._v(" DEBUG")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("do")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" container"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("initializeCloudKitSchema")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Handle any errors.")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive property"}},[a("span",{pre:!0,attrs:{class:"token directive-name"}},[t._v("#endif")])]),t._v("\n    container"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("loadPersistentStores")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("completionHandler"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("storeDescription"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" error "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" error "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("NSError")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fatalError")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string-literal"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Unresolved error ')]),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("\\(")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[t._v("error")]),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v(", ")]),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("\\(")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[t._v("error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("userInfo")]),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" container\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[t._v("上面代码中容易出问题的地方是")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("配置文件需要是 file:// 格式的，否则会报错 "),a("code",[t._v("CoreData SQL stores only support file URLs")])])]),t._v(" "),a("li",[a("p",[t._v("文件存储的位置自己指定，如果只用本地存储的话，CoreData 是默认将文件存在了 Library/Application\\ Support 下的，这里是指定位置存储，放在了 Documents 目录下，存储后的沙盒目录节奏如下，之前配置的 "),a("a",{attrs:{href:"http://local.store",target:"_blank",rel:"noopener noreferrer"}},[t._v("local.store"),a("OutboundLink")],1),t._v(" 和 "),a("a",{attrs:{href:"http://cloud.store",target:"_blank",rel:"noopener noreferrer"}},[t._v("cloud.store"),a("OutboundLink")],1),t._v(" 是作为单独的文件存在的。不过有意思的事儿，local.store 里还是有 CloudEntity 表的，只不过表里没有数据，只有 LocalEntity 表里有数据。")])]),t._v(" "),a("li",[a("p",[t._v('不支持 CloudEntity 和 LocalEntity 同在一个存储文件的做法， 同一个存储文件反复添加会触发 "Can\'t add the same store twice" 的错误')]),t._v(" "),a("p",[a("img",{attrs:{src:s(387),alt:"Untitled"}})])])]),t._v(" "),a("p",[t._v("成功配置之后终端会有如下输出")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("<NSCloudKitMirroringDelegate: 0x7f9699d29a90>: Successfully set up CloudKit \n    integration for store\n")])])]),a("h2",{attrs:{id:"编写存储相关代码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#编写存储相关代码"}},[t._v("#")]),t._v(" 编写存储相关代码")]),t._v(" "),a("p",[t._v("代码如下")]),t._v(" "),a("div",{staticClass:"language-swift extra-class"},[a("pre",{pre:!0,attrs:{class:"language-swift"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function-definition function"}},[t._v("storeCloudEntity")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" appDelegate "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UIApplication")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("shared"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("delegate "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AppDelegate")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" entity "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CloudEntity")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" appDelegate"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("persistentContainer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("viewContext"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    entity"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cloudage "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v("\n    entity"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cloudname "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-literal"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"hello"')])]),t._v("\n    appDelegate"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("persistentContainer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("viewContext"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("insert")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("entity"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function-definition function"}},[t._v("storeLocalEntity")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" appDelegate "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UIApplication")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("shared"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("delegate "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AppDelegate")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" entity "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("LocalEntity")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" appDelegate"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("persistentContainer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("viewContext"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    entity"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("localage "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),t._v("\n    entity"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("localname "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string-literal"}},[a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"localhello"')])]),t._v("\n    appDelegate"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("persistentContainer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("viewContext"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("insert")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("entity"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v(" appDelegate"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("persistentContainer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("viewContext"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("save")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("触发对应的方法后查看保存效果")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("**云端数据查看。**点击工程配置里的 iCloud 部分中的 CloudKit Console 进入后端服务台查看存储数据")]),t._v(" "),a("p",[a("img",{attrs:{src:s(388),alt:"Untitled"}})])]),t._v(" "),a("li",[a("p",[a("strong",[t._v("本地数据查看。")])]),t._v(" "),a("div",{staticClass:"language-swift extra-class"},[a("pre",{pre:!0,attrs:{class:"language-swift"}},[a("code",[t._v("sqlite"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tables\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ZCLOUDENTITY")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ZLOCALENTITY")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("Z_METADATA")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("Z_MODELCACHE")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("Z_PRIMARYKEY")]),t._v("\nsqlite"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" select "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" from "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ZLOCALENTITY")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("localhello\n")])])])])]),t._v(" "),a("p",[t._v("这里遇到的一些问题")]),t._v(" "),a("ol",[a("li",[t._v("在配置哪些表往云端存储的时候，如果表之前配置的是在Cloud 配置中，后面又改成 Local 配置，再次使用的时候会报错 "),a("code",[t._v("The model configuration used to open the store is incompatible with the one that was used to create the store.")]),t._v("解决方法就是清缓存，可以参考 StackOverflow 上的"),a("a",{attrs:{href:"https://stackoverflow.com/questions/8881453/the-model-used-to-open-the-store-is-incompatible-with-the-one-used-to-create-the",target:"_blank",rel:"noopener noreferrer"}},[t._v("回答"),a("OutboundLink")],1),t._v("。重新调整后也可以重置云端的开发环境，重置后会丢失掉开发中的数据。")]),t._v(" "),a("li",[t._v("在查找云端数据的时候，比如在上图 QueryRecords 的时候首次会失败 "),a("code",[t._v("Field 'recordName' is not marked queryable")]),t._v("，需要在对应的 Entity（或者叫Record） 的 Indexes 上添加 recordName，参考 StackOverflow 上的"),a("a",{attrs:{href:"https://stackoverflow.com/questions/69610184/field-recordname-is-not-marked-queryable-cloudkit-dashboard",target:"_blank",rel:"noopener noreferrer"}},[t._v("回答"),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("li",[t._v("查找云端数据的时候 DB 要选择 PrivateDatabase，Zone 是  "),a("code",[t._v("com.apple.coredata.cloudkit.zone")]),t._v("。如果你刚 Save 完的话，云端是没有 "),a("code",[t._v("com.apple.coredata.cloudkit.zone")]),t._v(" 的，只有一个 "),a("code",[t._v("_defaultZone")]),t._v("，这俩 zone 是不一样的，"),a("code",[t._v("com.apple.coredata.cloudkit.zone")]),t._v(" 需要一点时间出现。关于这部分内容官方也提供了一个指南 "),a("a",{attrs:{href:"https://developer.apple.com/documentation/cloudkit/managing_icloud_containers_with_the_cloudkit_database_app#//apple_ref/doc/uid/TP40014987-CH5",target:"_blank",rel:"noopener noreferrer"}},[t._v("Managing iCloud Containers with the CloudKit Database App"),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("li",[t._v("iCloud 同步如果是用模拟器的话有手动触发的选项，非常快能看到远端的数据。")]),t._v(" "),a("li",[t._v("上线的时候需要在 iCloud 后台将服务部署在 Production 环境上，否则还是没有办法同步。")])]),t._v(" "),a("p",[t._v("基本上整体配置和开发流程就是这样，后面还会涉及到数据的同步对界面的变化，后面再说。")]),t._v(" "),a("p",[t._v("参考地址:")]),t._v(" "),a("ol",[a("li",[a("a",{attrs:{href:"https://developer.apple.com/documentation/coredata/mirroring_a_core_data_store_with_cloudkit",target:"_blank",rel:"noopener noreferrer"}},[t._v("Apple-Mirroring a Core Data Store with CloudKit"),a("OutboundLink")],1)])]),t._v(" "),a("p",[t._v("相关链接:")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://fanthus.github.io/2022/11/08/coredata%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-1/",target:"_blank",rel:"noopener noreferrer"}},[t._v("CoreData学习笔记 1"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://fanthus.github.io/2022/11/24/coredata%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-2/",target:"_blank",rel:"noopener noreferrer"}},[t._v("CoreData学习笔记 2"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://fanthus.github.io/2022/11/24/coredata%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-3/",target:"_blank",rel:"noopener noreferrer"}},[t._v("CoreData学习笔记 3"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://fanthus.github.io/2022/11/25/coredata%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-4/",target:"_blank",rel:"noopener noreferrer"}},[t._v("CoreData学习笔记 4"),a("OutboundLink")],1)])]),t._v(" "),a("Vssue",{attrs:{title:t.CoreData学习笔记_4}})],1)}),[],!1,null,null,null);a.default=e.exports}}]);