<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CoreData 学习笔记七-CoreData+TableView差量数据源更新 | fanthus&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/logo.jpg">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <script async="true" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3512514942188386" crossorigin="anonymous"></script>
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-MEH5F43SVB"></script>
    <script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-MEH5F43SVB');</script>
    <script>console.log("my name is fanthus, hope my blog bring new ideas to you.");</script>
    <meta name="description" content="这篇笔记是介绍使用 CoreData+TableView 中使用差量数据源（Diffable Datasource）。使用差量数据源的起因是，在 CoreData+TableView+iCloud 使用过程中遇到的一个 Crash 的问题。经常在同步的时候遇到下面这个崩溃报错：

&gt; ** Terminating app due to uncaught exception &#39;NSInternalI ...">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/0.styles.232103a7.css" as="style"><link rel="preload" href="/assets/js/app.5c2aadbb.js" as="script"><link rel="preload" href="/assets/js/29.1acae59f.js" as="script"><link rel="preload" href="/assets/js/3.7fe07bf0.js" as="script"><link rel="preload" href="/assets/js/106.3b985ff7.js" as="script"><link rel="prefetch" href="/assets/js/10.e6af762e.js"><link rel="prefetch" href="/assets/js/100.67476119.js"><link rel="prefetch" href="/assets/js/101.f5eb858c.js"><link rel="prefetch" href="/assets/js/102.03da866a.js"><link rel="prefetch" href="/assets/js/103.fb86a639.js"><link rel="prefetch" href="/assets/js/104.3cfe1a59.js"><link rel="prefetch" href="/assets/js/105.06df8093.js"><link rel="prefetch" href="/assets/js/107.bc3ffbc8.js"><link rel="prefetch" href="/assets/js/108.4b873cd8.js"><link rel="prefetch" href="/assets/js/109.cf2e8bfc.js"><link rel="prefetch" href="/assets/js/11.ec904e86.js"><link rel="prefetch" href="/assets/js/110.d0e1f360.js"><link rel="prefetch" href="/assets/js/111.32710987.js"><link rel="prefetch" href="/assets/js/112.17690a92.js"><link rel="prefetch" href="/assets/js/113.589070d1.js"><link rel="prefetch" href="/assets/js/114.bec863ac.js"><link rel="prefetch" href="/assets/js/115.66decc99.js"><link rel="prefetch" href="/assets/js/116.b3bfe4dc.js"><link rel="prefetch" href="/assets/js/117.75a5a39d.js"><link rel="prefetch" href="/assets/js/118.e0dd863f.js"><link rel="prefetch" href="/assets/js/119.94c2e0bb.js"><link rel="prefetch" href="/assets/js/12.14256cbe.js"><link rel="prefetch" href="/assets/js/120.c8b76def.js"><link rel="prefetch" href="/assets/js/121.dfdfd9b0.js"><link rel="prefetch" href="/assets/js/122.10da6a05.js"><link rel="prefetch" href="/assets/js/123.e9d46721.js"><link rel="prefetch" href="/assets/js/124.577feddf.js"><link rel="prefetch" href="/assets/js/125.8129b423.js"><link rel="prefetch" href="/assets/js/126.c20f17ba.js"><link rel="prefetch" href="/assets/js/127.7e1c5ded.js"><link rel="prefetch" href="/assets/js/128.5d4e17c0.js"><link rel="prefetch" href="/assets/js/129.f1c8af0e.js"><link rel="prefetch" href="/assets/js/13.6af70c38.js"><link rel="prefetch" href="/assets/js/14.95f777b8.js"><link rel="prefetch" href="/assets/js/15.9c1287ff.js"><link rel="prefetch" href="/assets/js/16.a57aacc5.js"><link rel="prefetch" href="/assets/js/17.5c124641.js"><link rel="prefetch" href="/assets/js/18.6db94c74.js"><link rel="prefetch" href="/assets/js/19.60cf2d9c.js"><link rel="prefetch" href="/assets/js/20.08713c1b.js"><link rel="prefetch" href="/assets/js/21.5eadef54.js"><link rel="prefetch" href="/assets/js/22.66422fed.js"><link rel="prefetch" href="/assets/js/23.739fb024.js"><link rel="prefetch" href="/assets/js/24.c76333d1.js"><link rel="prefetch" href="/assets/js/25.8b10e134.js"><link rel="prefetch" href="/assets/js/26.cfba7153.js"><link rel="prefetch" href="/assets/js/27.72eb7481.js"><link rel="prefetch" href="/assets/js/28.6dcef05c.js"><link rel="prefetch" href="/assets/js/30.2b7c71b4.js"><link rel="prefetch" href="/assets/js/31.5ca92641.js"><link rel="prefetch" href="/assets/js/32.8daba902.js"><link rel="prefetch" href="/assets/js/33.6edbf98d.js"><link rel="prefetch" href="/assets/js/34.84367f88.js"><link rel="prefetch" href="/assets/js/35.85b0ec62.js"><link rel="prefetch" href="/assets/js/36.6cf4ed41.js"><link rel="prefetch" href="/assets/js/37.ee892674.js"><link rel="prefetch" href="/assets/js/38.b7997b04.js"><link rel="prefetch" href="/assets/js/39.90e0d74a.js"><link rel="prefetch" href="/assets/js/4.03934060.js"><link rel="prefetch" href="/assets/js/40.dfc8ad6a.js"><link rel="prefetch" href="/assets/js/41.b60c8046.js"><link rel="prefetch" href="/assets/js/42.77c1c836.js"><link rel="prefetch" href="/assets/js/43.c9d4221c.js"><link rel="prefetch" href="/assets/js/44.6348d9cc.js"><link rel="prefetch" href="/assets/js/45.126bc7fe.js"><link rel="prefetch" href="/assets/js/46.4a3e70e0.js"><link rel="prefetch" href="/assets/js/47.67a75c47.js"><link rel="prefetch" href="/assets/js/48.83f0f7f0.js"><link rel="prefetch" href="/assets/js/49.f7dc76c9.js"><link rel="prefetch" href="/assets/js/5.543a8f29.js"><link rel="prefetch" href="/assets/js/50.e7cc6057.js"><link rel="prefetch" href="/assets/js/51.adabfc4f.js"><link rel="prefetch" href="/assets/js/52.e28c8d20.js"><link rel="prefetch" href="/assets/js/53.13d2e30c.js"><link rel="prefetch" href="/assets/js/54.c393a991.js"><link rel="prefetch" href="/assets/js/55.460bb0db.js"><link rel="prefetch" href="/assets/js/56.2d1300fd.js"><link rel="prefetch" href="/assets/js/57.6ea9c916.js"><link rel="prefetch" href="/assets/js/58.65b856f8.js"><link rel="prefetch" href="/assets/js/59.6a97c2b7.js"><link rel="prefetch" href="/assets/js/6.34df74c1.js"><link rel="prefetch" href="/assets/js/60.f78b3bf5.js"><link rel="prefetch" href="/assets/js/61.bee131bd.js"><link rel="prefetch" href="/assets/js/62.20ab782f.js"><link rel="prefetch" href="/assets/js/63.7055d872.js"><link rel="prefetch" href="/assets/js/64.d894c341.js"><link rel="prefetch" href="/assets/js/65.b39cadbd.js"><link rel="prefetch" href="/assets/js/66.7a13fc1f.js"><link rel="prefetch" href="/assets/js/67.a6766c4f.js"><link rel="prefetch" href="/assets/js/68.80cf9177.js"><link rel="prefetch" href="/assets/js/69.8ca05e24.js"><link rel="prefetch" href="/assets/js/7.2861f040.js"><link rel="prefetch" href="/assets/js/70.5802ac79.js"><link rel="prefetch" href="/assets/js/71.a8629828.js"><link rel="prefetch" href="/assets/js/72.3b93f7e3.js"><link rel="prefetch" href="/assets/js/73.c8c6e94d.js"><link rel="prefetch" href="/assets/js/74.dbeef2ae.js"><link rel="prefetch" href="/assets/js/75.a71f1c86.js"><link rel="prefetch" href="/assets/js/76.8ea1e96d.js"><link rel="prefetch" href="/assets/js/77.53f0b3f9.js"><link rel="prefetch" href="/assets/js/78.a6e06276.js"><link rel="prefetch" href="/assets/js/79.d7641e2b.js"><link rel="prefetch" href="/assets/js/8.2e921966.js"><link rel="prefetch" href="/assets/js/80.ea6354e1.js"><link rel="prefetch" href="/assets/js/81.a9b14e4a.js"><link rel="prefetch" href="/assets/js/82.1634e735.js"><link rel="prefetch" href="/assets/js/83.0cf5ca64.js"><link rel="prefetch" href="/assets/js/84.a70476ff.js"><link rel="prefetch" href="/assets/js/85.d2b36360.js"><link rel="prefetch" href="/assets/js/86.251249e0.js"><link rel="prefetch" href="/assets/js/87.7f2a1a00.js"><link rel="prefetch" href="/assets/js/88.911418c4.js"><link rel="prefetch" href="/assets/js/89.23d86aa2.js"><link rel="prefetch" href="/assets/js/9.f375de0b.js"><link rel="prefetch" href="/assets/js/90.7a69da44.js"><link rel="prefetch" href="/assets/js/91.acb56149.js"><link rel="prefetch" href="/assets/js/92.8b6fb89a.js"><link rel="prefetch" href="/assets/js/93.01d50793.js"><link rel="prefetch" href="/assets/js/94.e6a5de4e.js"><link rel="prefetch" href="/assets/js/95.5ddea806.js"><link rel="prefetch" href="/assets/js/96.9ce28405.js"><link rel="prefetch" href="/assets/js/97.f82294e4.js"><link rel="prefetch" href="/assets/js/98.27393bcb.js"><link rel="prefetch" href="/assets/js/99.b851e6bb.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.b6901552.js">
    <link rel="stylesheet" href="/assets/css/0.styles.232103a7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">fanthus's blog </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/tag/" class="nav-link">Tags</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">fanthus's blog </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">Tags</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        CoreData 学习笔记七-CoreData+TableView差量数据源更新
      </h1> <div class="post-meta"><!----> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2023-02-08T11:38:01.000Z">
      Wed Feb 08 2023
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-42ccfcd5><a href="/tag/CoreData" data-v-42ccfcd5><span data-v-42ccfcd5>CoreData</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/tag/iOS" data-v-42ccfcd5><span data-v-42ccfcd5>iOS</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/tag/macOS" data-v-42ccfcd5><span data-v-42ccfcd5>macOS</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><p>这篇笔记是介绍使用 CoreData+TableView 中使用差量数据源（Diffable Datasource）。使用差量数据源的起因是，在 CoreData+TableView+iCloud 使用过程中遇到的一个 Crash 的问题。经常在同步的时候遇到下面这个崩溃报错：</p> <blockquote><p>** Terminating app due to uncaught exception 'NSInternalInconsistencyException', reason: 'attempt to delete item 4 from section 0 which only contains 4 items before the update'
terminating with uncaught exception of type NSException</p></blockquote> <p>这特别像以前使用 TableView/CollectionView 中的一个使用报错：</p> <blockquote><p>Terminating app due to uncaught exception 'NSInternalInconsistencyException', reason: 'Invalid update: invalid number of rows in section 0. The number of rows contained in an existing section after the update (1) must be equal to the number of rows contained in that section before the update (1), plus or minus the number of rows inserted or deleted from that section (0 inserted, 1 deleted) and plus or minus the number of rows moved into or out of that section (0 moved in, 0 moved out).</p></blockquote> <p>这个报错的本质原因是在 update tableview/collectionView 的时候数据源和视图操作没有匹配导致的。但是 CoreData 中的这个报错是怎么回事呢？本质也是类似的，还是数据一致性没有做好。但是像这种 case，因为我们是使用 <code>NSFetchedResultsController</code> 来管理数据同步操作，所以这种问题并不好解决，怎么办？在网上搜索到遇到类似问题的<a href="https://aplus.rs/2022/diffable-data-source-core-data-frc/" target="_blank" rel="noopener noreferrer">解决方案<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，即使用差量数据源的方案。关于差量数据源的说明，可以参考我之前的这篇笔记<a href="https://fanthus.github.io/2023/02/07/uitableview-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-1/" target="_blank" rel="noopener noreferrer">UITableView学习笔记一-差量数据源<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>回到这篇笔记的主题，如何在 CoreData+TableView 中使用差量数据源。总的过程和 <code>UITableView</code> 中使用差量数据源的步骤类似，不过需要结合 <code>NSFetchedResultsController</code> 的代理方法。下面是代码部分，代码说明部分有详细的说明</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">enum</span> <span class="token class-name">Section</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> main
<span class="token punctuation">}</span>

<span class="token keyword">lazy</span> <span class="token keyword">var</span> collectionView<span class="token punctuation">:</span><span class="token class-name">UICollectionView</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> collectionView <span class="token operator">=</span> <span class="token class-name">UICollectionView</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>xxx<span class="token punctuation">)</span>
    collectionView<span class="token punctuation">.</span>delegate <span class="token operator">=</span> <span class="token keyword">self</span>
    <span class="token keyword">return</span> collectionView
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> fetchedResultsController<span class="token punctuation">:</span><span class="token class-name">NSFetchedResultsController</span><span class="token operator">&lt;</span><span class="token class-name">Student</span><span class="token operator">&gt;!</span>
<span class="token keyword">var</span> diffableDataSource<span class="token punctuation">:</span><span class="token class-name">UICollectionViewDiffableDataSource</span><span class="token operator">&lt;</span><span class="token class-name">Section</span><span class="token punctuation">,</span> <span class="token class-name">NSManagedObjectID</span><span class="token operator">&gt;!</span>

<span class="token keyword">override</span> <span class="token keyword">func</span> <span class="token function-definition function">viewDidLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">viewDidLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">setCollectionViewDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">setupFetchedResultsController</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//设置数据源</span>
<span class="token keyword">func</span> <span class="token function-definition function">setCollectionViewDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>diffableDataSource <span class="token operator">=</span> <span class="token class-name">UICollectionViewDiffableDataSource</span><span class="token operator">&lt;</span><span class="token class-name">Section</span><span class="token punctuation">,</span> <span class="token class-name">NSManagedObjectID</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>collectionView<span class="token punctuation">:</span> collectionView<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span><span class="token keyword">weak</span> <span class="token keyword">self</span><span class="token punctuation">]</span>  <span class="token punctuation">(</span>collectionView<span class="token punctuation">,</span> indexPath<span class="token punctuation">,</span> objectID<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">UICollectionViewCell</span><span class="token operator">?</span> <span class="token keyword">in</span>
        <span class="token keyword">guard</span> <span class="token keyword">let</span> wself <span class="token operator">=</span> <span class="token keyword">self</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token nil constant">nil</span> <span class="token punctuation">}</span>
        <span class="token keyword">guard</span> <span class="token keyword">let</span> copyItem <span class="token operator">=</span> <span class="token keyword">try</span><span class="token operator">?</span> <span class="token function">managedContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">existingObject</span><span class="token punctuation">(</span>with<span class="token punctuation">:</span> objectID<span class="token punctuation">)</span> <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">CopyItem</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">fatalError</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;Managed object should be available&quot;</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">let</span> cell <span class="token operator">=</span> collectionView<span class="token punctuation">.</span><span class="token function">dequeueReusableCell</span><span class="token punctuation">(</span>withReuseIdentifier<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;cellid&quot;</span></span><span class="token punctuation">,</span> <span class="token keyword">for</span><span class="token punctuation">:</span> indexPath<span class="token punctuation">)</span> 
        <span class="token comment">//config cell</span>
        <span class="token keyword">return</span> cell
    <span class="token punctuation">}</span>
    collectionView<span class="token punctuation">.</span>dataSource <span class="token operator">=</span> diffableDataSource
<span class="token punctuation">}</span>

<span class="token comment">/// 配置结果控制器</span>
<span class="token keyword">func</span> <span class="token function-definition function">setupFetchedResultsController</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> fetchRequest<span class="token punctuation">:</span><span class="token class-name">NSFetchRequest</span><span class="token operator">&lt;</span><span class="token class-name">Student</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token class-name">Student</span><span class="token punctuation">.</span><span class="token function">fetchRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    fetchRequest<span class="token punctuation">.</span>sortDescriptors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token class-name">NSSortDescriptor</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;score&quot;</span></span><span class="token punctuation">,</span> ascending<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    fetchedResultsController <span class="token operator">=</span> <span class="token class-name">NSFetchedResultsController</span><span class="token punctuation">(</span>fetchRequest<span class="token punctuation">:</span> fetchRequest<span class="token punctuation">,</span> managedObjectContext<span class="token punctuation">:</span> <span class="token function">managedContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sectionNameKeyPath<span class="token punctuation">:</span> <span class="token nil constant">nil</span><span class="token punctuation">,</span> cacheName<span class="token punctuation">:</span> <span class="token nil constant">nil</span><span class="token punctuation">)</span>
    fetchedResultsController<span class="token punctuation">.</span>delegate <span class="token operator">=</span> <span class="token keyword">self</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> fetchedResultsController<span class="token punctuation">.</span><span class="token function">performFetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
        <span class="token class-name">NSLog</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;fetch results error: </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">error</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/// 实现 NSFetchedResultsControllerDelegate</span>
<span class="token keyword">extension</span> <span class="token class-name">ViewController</span><span class="token punctuation">:</span><span class="token class-name">NSFetchedResultsControllerDelegate</span> <span class="token punctuation">{</span>
    <span class="token keyword">func</span> <span class="token function-definition function">controller</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> controller<span class="token punctuation">:</span> <span class="token class-name">NSFetchedResultsController</span><span class="token operator">&lt;</span><span class="token class-name">NSFetchRequestResult</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> didChangeContentWith snapshot<span class="token punctuation">:</span> <span class="token class-name">NSDiffableDataSourceSnapshotReference</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">guard</span> <span class="token keyword">let</span> dataSource <span class="token operator">=</span> collectionView<span class="token punctuation">.</span>dataSource <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">UICollectionViewDiffableDataSource</span><span class="token operator">&lt;</span><span class="token class-name">Section</span><span class="token punctuation">,</span> <span class="token class-name">NSManagedObjectID</span><span class="token operator">&gt;</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">assertionFailure</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;The data source has not implemented snapshot support while it should&quot;</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">var</span> snapshot <span class="token operator">=</span> snapshot <span class="token keyword">as</span> <span class="token class-name">NSDiffableDataSourceSnapshot</span><span class="token operator">&lt;</span><span class="token class-name">Section</span><span class="token punctuation">,</span> <span class="token class-name">NSManagedObjectID</span><span class="token operator">&gt;</span>
        diffableDataSource<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>snapshot<span class="token punctuation">,</span> animatingDifferences<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>代码说明</p> <ol><li><p>差量数据源（Diffable DataSources）的类型声明需要为 <code>UICollectionViewDiffableDataSource&lt;Section, NSManagedObjectID&gt;</code>，需要关注的是 <code>ItemIdentifierType</code> 不能为最终的数据类型，而是 <code>NSManagedObjectID</code>，否则会在后续的 <code>NSDiffableDataSourceSnapshot</code> 类型转换中报错</p> <blockquote><p>Could not cast value of type '_NSCoreDataTaggedObjectID' (0x1eaaefba0) to 'Demo.Student' (0x100e50f60).</p></blockquote></li> <li><p>在差量数据源构建的 cell provider 回调中，需要通过 <code>NSManagedObjectID</code> 实例来获取待渲染的 Entity 实例。</p></li> <li><p>使用差量数据源后 reloadData 以及 performUpdates 不能再继续使用了，基本上可以告别历史舞台。</p></li> <li><p>如果你看过参考地址 <a href="https://www.avanderlee.com/swift/diffable-data-sources-core-data/" target="_blank" rel="noopener noreferrer">How-to use Diffable Data Sources with Core Data<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 中的 <code>NSFetchedResultsControllerDelegate</code> 的实现，他的代码里面有个新老snapshot对比的过程，我理解是因为他因为频繁的数据变更导致了性能低下，所以它自己先对比之后在新 snapshot 中先 reload。这里为了方便理解我就用了比较简单的代码，而且大部分时候我们遇不上这种性能问题，遇到了再优化不迟。</p></li></ol> <p>分享在具体开发中遇到的一个问题是，当向列表中新增数据（假设是 Student 实例）调用 <code>managedContext.save()</code> 的时候，会触发 <code>NSFetchedResultsControllerDelegate</code> 代理方法 <code>controller(_ controller:, didChangeContentWithSnapshot:)</code>，我们在方法最后正常 apply()，页面正常添加数据完毕后。用户如果接着做了某个操作触发了列表的更新操作，更新操作中复用当前 <code>snapshot.itemIdentifiers</code> ，则有可能在差量数据源的 cell provider 回调中通过 <code>managedContext.existingObject(with:objectId)</code> 会拿到空的数据，影响我们接下来对 cell 进行配置操作。出现这种问题的原因是 Student 实例的 objectId 在 <code>managedContext.save()</code> 前后是不一样的。更新触发的列表操作还是拿着之前实例的 objectId （可以理解为保存本地前的内存中 objectId）去找所以是找不到的，解决方案是，在用户触发操作的时候先对 <code>snapshot.itemIdentifiers</code> 先筛一遍过滤掉已经失效的 objectId。</p> <blockquote><p>上面如果 cell provider 中通过 <code>managedContext.object(with:objectId)</code> 方法会拿到一个占位数据。具体参考两个 API 的区别。我自己理解 <code>managedContext.existingObject(with:objectId)</code> 相对更加靠谱一些。</p></blockquote> <p>总的来说 CoreData+TableView+DiffableDataSource 的更新方式更加简化了老式 <code>NSFetchedResultsControllerDelegate</code> 协议的实现方式，对开发者来说用起来更加简单，也不会再遇到开头那种崩溃的问题了。</p> <p>参考地址</p> <ol><li><a href="https://aplus.rs/2022/diffable-data-source-core-data-frc/" target="_blank" rel="noopener noreferrer">Using NSFetchedResultsController’s diffable snapshot with UICollectionView’s diffable data source<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.avanderlee.com/swift/diffable-data-sources-core-data/" target="_blank" rel="noopener noreferrer">How-to use Diffable Data Sources with Core Data<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ol> <!----></div> <footer><!----> <hr> <!----></footer></article> <!----></div></div> <footer class="footer" data-v-3d9deeb8><div class="footer-left-wrap" data-v-3d9deeb8><ul class="contact" data-v-3d9deeb8></ul></div> <div class="footer-right-wrap" data-v-3d9deeb8><ul class="copyright" data-v-3d9deeb8></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5c2aadbb.js" defer></script><script src="/assets/js/29.1acae59f.js" defer></script><script src="/assets/js/3.7fe07bf0.js" defer></script><script src="/assets/js/106.3b985ff7.js" defer></script>
  </body>
</html>
