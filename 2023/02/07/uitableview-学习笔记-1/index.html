<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>UITableView学习笔记一-差量数据源 | fanthus&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/logo.jpg">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <script async="true" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3512514942188386" crossorigin="anonymous"></script>
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-MEH5F43SVB"></script>
    <script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-MEH5F43SVB');</script>
    <script>console.log("my name is fanthus, hope my blog bring new ideas to you.");</script>
    <meta name="description" content="这篇笔记是介绍基于差量数据源(diffable data source)去更新列表展示的使用说明。对 UITableView 和 UICollectionView 都生效，这边笔记是用 UITableView 为例子的。

普通数据源方式

通常来说我们都是让包含 TableView 实例的视图控制器实现 UITableViewDataSource 协议，实现对应的方法，类似 ...">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/0.styles.232103a7.css" as="style"><link rel="preload" href="/assets/js/app.2cedb1d8.js" as="script"><link rel="preload" href="/assets/js/29.309f71c0.js" as="script"><link rel="preload" href="/assets/js/3.e78f3171.js" as="script"><link rel="preload" href="/assets/js/105.57832bba.js" as="script"><link rel="prefetch" href="/assets/js/10.4cd31608.js"><link rel="prefetch" href="/assets/js/100.3443112a.js"><link rel="prefetch" href="/assets/js/101.e0037931.js"><link rel="prefetch" href="/assets/js/102.f4c7589f.js"><link rel="prefetch" href="/assets/js/103.0df46cd4.js"><link rel="prefetch" href="/assets/js/104.17a0ee44.js"><link rel="prefetch" href="/assets/js/106.680eda55.js"><link rel="prefetch" href="/assets/js/107.410f297e.js"><link rel="prefetch" href="/assets/js/108.fb80d3ad.js"><link rel="prefetch" href="/assets/js/109.699c7520.js"><link rel="prefetch" href="/assets/js/11.7393e510.js"><link rel="prefetch" href="/assets/js/110.d4f0aca9.js"><link rel="prefetch" href="/assets/js/111.372545eb.js"><link rel="prefetch" href="/assets/js/112.bc127403.js"><link rel="prefetch" href="/assets/js/113.414e616f.js"><link rel="prefetch" href="/assets/js/114.d8c4fe8d.js"><link rel="prefetch" href="/assets/js/115.279ec90c.js"><link rel="prefetch" href="/assets/js/116.c60ac54a.js"><link rel="prefetch" href="/assets/js/117.15c04390.js"><link rel="prefetch" href="/assets/js/118.f9d8228c.js"><link rel="prefetch" href="/assets/js/119.719d77b5.js"><link rel="prefetch" href="/assets/js/12.c35fa779.js"><link rel="prefetch" href="/assets/js/120.cf48f47a.js"><link rel="prefetch" href="/assets/js/121.4aad0ac7.js"><link rel="prefetch" href="/assets/js/122.15f2b5ef.js"><link rel="prefetch" href="/assets/js/123.4dea98c9.js"><link rel="prefetch" href="/assets/js/124.0152be90.js"><link rel="prefetch" href="/assets/js/125.ecf56222.js"><link rel="prefetch" href="/assets/js/126.50fe6660.js"><link rel="prefetch" href="/assets/js/127.28abe492.js"><link rel="prefetch" href="/assets/js/128.48a0862c.js"><link rel="prefetch" href="/assets/js/129.77b2b203.js"><link rel="prefetch" href="/assets/js/13.35658260.js"><link rel="prefetch" href="/assets/js/130.d0ef4952.js"><link rel="prefetch" href="/assets/js/131.55b00f57.js"><link rel="prefetch" href="/assets/js/14.4e33e6a2.js"><link rel="prefetch" href="/assets/js/15.345a84a1.js"><link rel="prefetch" href="/assets/js/16.3d596c76.js"><link rel="prefetch" href="/assets/js/17.3e2e1a7a.js"><link rel="prefetch" href="/assets/js/18.c8e88810.js"><link rel="prefetch" href="/assets/js/19.f0e3f187.js"><link rel="prefetch" href="/assets/js/20.cb5c866b.js"><link rel="prefetch" href="/assets/js/21.b83191ac.js"><link rel="prefetch" href="/assets/js/22.bea483cb.js"><link rel="prefetch" href="/assets/js/23.3877c278.js"><link rel="prefetch" href="/assets/js/24.0524a7e6.js"><link rel="prefetch" href="/assets/js/25.3f3c78fe.js"><link rel="prefetch" href="/assets/js/26.3f72710f.js"><link rel="prefetch" href="/assets/js/27.f35bb8e9.js"><link rel="prefetch" href="/assets/js/28.5e29b9fe.js"><link rel="prefetch" href="/assets/js/30.a60200be.js"><link rel="prefetch" href="/assets/js/31.c2accd33.js"><link rel="prefetch" href="/assets/js/32.41be2bbb.js"><link rel="prefetch" href="/assets/js/33.8447af66.js"><link rel="prefetch" href="/assets/js/34.122a4606.js"><link rel="prefetch" href="/assets/js/35.fa9f0fe8.js"><link rel="prefetch" href="/assets/js/36.ffc459c1.js"><link rel="prefetch" href="/assets/js/37.12421aeb.js"><link rel="prefetch" href="/assets/js/38.66884bf5.js"><link rel="prefetch" href="/assets/js/39.4901c209.js"><link rel="prefetch" href="/assets/js/4.41416bc4.js"><link rel="prefetch" href="/assets/js/40.726f0f90.js"><link rel="prefetch" href="/assets/js/41.1466329e.js"><link rel="prefetch" href="/assets/js/42.ad110115.js"><link rel="prefetch" href="/assets/js/43.42f6c87f.js"><link rel="prefetch" href="/assets/js/44.38a3ffda.js"><link rel="prefetch" href="/assets/js/45.54729d58.js"><link rel="prefetch" href="/assets/js/46.688f019f.js"><link rel="prefetch" href="/assets/js/47.069217c5.js"><link rel="prefetch" href="/assets/js/48.0227b0c3.js"><link rel="prefetch" href="/assets/js/49.7a3d3511.js"><link rel="prefetch" href="/assets/js/5.9be8c1b7.js"><link rel="prefetch" href="/assets/js/50.35d1d592.js"><link rel="prefetch" href="/assets/js/51.7e7b901a.js"><link rel="prefetch" href="/assets/js/52.f693d3ed.js"><link rel="prefetch" href="/assets/js/53.c4c4d1a2.js"><link rel="prefetch" href="/assets/js/54.eab66332.js"><link rel="prefetch" href="/assets/js/55.7e80dbb1.js"><link rel="prefetch" href="/assets/js/56.1041c5f3.js"><link rel="prefetch" href="/assets/js/57.a7c1bc68.js"><link rel="prefetch" href="/assets/js/58.c07c376a.js"><link rel="prefetch" href="/assets/js/59.8b20d651.js"><link rel="prefetch" href="/assets/js/6.1724a888.js"><link rel="prefetch" href="/assets/js/60.417e91a2.js"><link rel="prefetch" href="/assets/js/61.4db451fd.js"><link rel="prefetch" href="/assets/js/62.8f0bdaac.js"><link rel="prefetch" href="/assets/js/63.911f46a9.js"><link rel="prefetch" href="/assets/js/64.60deeb3e.js"><link rel="prefetch" href="/assets/js/65.201e0e08.js"><link rel="prefetch" href="/assets/js/66.248f04bf.js"><link rel="prefetch" href="/assets/js/67.500ae9a1.js"><link rel="prefetch" href="/assets/js/68.a95fd5e5.js"><link rel="prefetch" href="/assets/js/69.24aaae86.js"><link rel="prefetch" href="/assets/js/7.934b58e4.js"><link rel="prefetch" href="/assets/js/70.ec2f6ce6.js"><link rel="prefetch" href="/assets/js/71.b454fdd6.js"><link rel="prefetch" href="/assets/js/72.74299778.js"><link rel="prefetch" href="/assets/js/73.3cd8645d.js"><link rel="prefetch" href="/assets/js/74.d5accf5c.js"><link rel="prefetch" href="/assets/js/75.2d01044b.js"><link rel="prefetch" href="/assets/js/76.f31f74e1.js"><link rel="prefetch" href="/assets/js/77.3b826970.js"><link rel="prefetch" href="/assets/js/78.b7547141.js"><link rel="prefetch" href="/assets/js/79.5d0ef470.js"><link rel="prefetch" href="/assets/js/8.2a195ce5.js"><link rel="prefetch" href="/assets/js/80.0b0b5a17.js"><link rel="prefetch" href="/assets/js/81.24f2588e.js"><link rel="prefetch" href="/assets/js/82.f8c84af4.js"><link rel="prefetch" href="/assets/js/83.7fff9a1b.js"><link rel="prefetch" href="/assets/js/84.c0208c2c.js"><link rel="prefetch" href="/assets/js/85.e363b25e.js"><link rel="prefetch" href="/assets/js/86.5837e9f1.js"><link rel="prefetch" href="/assets/js/87.3e2f38a0.js"><link rel="prefetch" href="/assets/js/88.d3958f6f.js"><link rel="prefetch" href="/assets/js/89.ec3fdee0.js"><link rel="prefetch" href="/assets/js/9.c0adb174.js"><link rel="prefetch" href="/assets/js/90.94654c43.js"><link rel="prefetch" href="/assets/js/91.76b106e7.js"><link rel="prefetch" href="/assets/js/92.69e5bf8b.js"><link rel="prefetch" href="/assets/js/93.3d4a8f29.js"><link rel="prefetch" href="/assets/js/94.202d1036.js"><link rel="prefetch" href="/assets/js/95.002d5790.js"><link rel="prefetch" href="/assets/js/96.044893c5.js"><link rel="prefetch" href="/assets/js/97.c6dec31d.js"><link rel="prefetch" href="/assets/js/98.20673f07.js"><link rel="prefetch" href="/assets/js/99.fa4a2cf2.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.91ff346d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.232103a7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">fanthus's blog </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/tag/" class="nav-link">Tags</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">fanthus's blog </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">Tags</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        UITableView学习笔记一-差量数据源
      </h1> <div class="post-meta"><!----> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2023-02-07T17:57:26.000Z">
      Tue Feb 07 2023
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-42ccfcd5><a href="/tag/UITableView" data-v-42ccfcd5><span data-v-42ccfcd5>UITableView</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/tag/iOS" data-v-42ccfcd5><span data-v-42ccfcd5>iOS</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><p>这篇笔记是介绍基于差量数据源(diffable data source)去更新列表展示的使用说明。对 <code>UITableView</code> 和 <code>UICollectionView</code> 都生效，这边笔记是用 <code>UITableView</code> 为例子的。</p> <h2 id="普通数据源方式"><a href="#普通数据源方式" class="header-anchor">#</a> 普通数据源方式</h2> <p>通常来说我们都是让包含 TableView 实例的视图控制器实现 <code>UITableViewDataSource</code> 协议，实现对应的方法，类似下面这样：</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">func</span> <span class="token function-definition function">numberOfSections</span><span class="token punctuation">(</span><span class="token keyword">in</span> tableView<span class="token punctuation">:</span> <span class="token class-name">UITableView</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Int</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> data<span class="token punctuation">.</span>sections<span class="token punctuation">.</span>count
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function-definition function">tableView</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> tableView<span class="token punctuation">:</span> <span class="token class-name">UITableView</span><span class="token punctuation">,</span> numberOfRowsInSection section<span class="token punctuation">:</span> <span class="token class-name">Int</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Int</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> data<span class="token punctuation">.</span>sections<span class="token punctuation">[</span>section<span class="token punctuation">]</span><span class="token punctuation">.</span>count
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function-definition function">tableView</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> tableView<span class="token punctuation">:</span> <span class="token class-name">UITableView</span><span class="token punctuation">,</span> cellForRowAt indexPath<span class="token punctuation">:</span> <span class="token class-name">IndexPath</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">UITableViewCell</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> cell <span class="token operator">=</span> tableView<span class="token punctuation">.</span><span class="token function">dequeueReusableCell</span><span class="token punctuation">(</span>withIdentifier<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;Identifier&quot;</span></span><span class="token punctuation">,</span> <span class="token keyword">for</span><span class="token punctuation">:</span> indexPath<span class="token punctuation">)</span>
    <span class="token comment">//config cell</span>
    <span class="token keyword">return</span> cell
<span class="token punctuation">}</span>
</code></pre></div><p>这种直接通过代理提供数据源的方式使用起来非常简单也比较直观，但是当涉及到一些比较复杂的处理的时候我们经常会遇到错误，比如下面这种报错:</p> <blockquote><p>Terminating app due to uncaught exception 'NSInternalInconsistencyException', reason: 'Invalid update: invalid number of rows in section 0. The number of rows contained in an existing section after the update (1) must be equal to the number of rows contained in that section before the update (1), plus or minus the number of rows inserted or deleted from that section (0 inserted, 1 deleted) and plus or minus the number of rows moved into or out of that section (0 moved in, 0 moved out).</p></blockquote> <p>这种报错的本质其实就是真实的数据源和 UI 视图层视图操作不匹配导致的，比如上面这个报错就是 调用 tableView.insertRows 的时候并没有在数据源上做对应的修改。</p> <p>很多时候为了避免上面这种视图和数据不匹配的情况，我们在插入数据后直接调用 tableView.reloadData 刷新，但是感觉这样很不优雅，对应的插入删除的动画效果没有了。</p> <p>总结一下传统的基于代理提供的数据源驱动列表更新的机制有如下两个问题：</p> <ol><li>容易出错。</li> <li>动画效果不理想。</li></ol> <h2 id="差量数据源方式"><a href="#差量数据源方式" class="header-anchor">#</a> 差量数据源方式</h2> <p>为了改进传统的代理数据源驱动方式，苹果提供了一套新的列表数据源方式，即差量数据源方式。基于差量数据源更新的总体思想是：<strong>视图展示快照数据，当快照发生变化的时候，调用更新方法，框架帮你做快照之间的diff，最终视图根据diff结果渲染后展示新快照数据。</strong> 具体到实际开发中对应到的两个类是：</p> <ol><li><p><a href="https://developer.apple.com/documentation/uikit/nsdiffabledatasourcesnapshot" target="_blank" rel="noopener noreferrer"><code>NSDiffableDataSourceSnapshot</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ：官方解释是「A representation of the state of the data in a view at a specific point in time」。我理解就类似是快照的概念，就某个时间点 UI 表示的真实数据的状态。</p> <p>差量数据源(diffable data source)就是使用快照(snapshot)来为 TableView 和 CollectionView 提供数据的。我们使用快照来设置初始化视图展示状态，同样地也用快照来反映视图数据的变化。快照中的数据是由我们要展示的 section 和 item 组成的，我们通过对 section 和 items 的增删改去操作快照。这里的 section 和 items 的概念其实是沿用下来了，还是和之前代理数据源的数据提供方式一致。</p></li> <li><p><a href="https://developer.apple.com/documentation/uikit/uitableviewdiffabledatasource" target="_blank" rel="noopener noreferrer"><code>UITableViewDiffableDataSource</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的官方 API 说明是「The object you use to manage data and provide cells for a table view」，即用来管理数据和提供 cell 的对象。</p></li></ol> <h2 id="demo"><a href="#demo" class="header-anchor">#</a> Demo</h2> <p>通过一个简单的例子来看一下这两个类是如何协作完成数据展示的：</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">enum</span> <span class="token class-name">Section</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> main
<span class="token punctuation">}</span> 
<span class="token keyword">struct</span> <span class="token class-name">Note</span><span class="token punctuation">:</span><span class="token class-name">Hashable</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> id<span class="token punctuation">:</span><span class="token class-name">Int</span>
    <span class="token keyword">var</span> content<span class="token punctuation">:</span><span class="token class-name">String</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">ViewController</span><span class="token punctuation">:</span> <span class="token class-name">UIViewController</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> tableView<span class="token punctuation">:</span><span class="token class-name">UITableView</span><span class="token operator">!</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> dataSource<span class="token punctuation">:</span><span class="token class-name">UITableViewDiffableDataSource</span><span class="token operator">&lt;</span><span class="token class-name">Section</span><span class="token punctuation">,</span> <span class="token class-name">Note</span><span class="token operator">&gt;!</span>

    <span class="token keyword">override</span> <span class="token keyword">func</span> <span class="token function-definition function">viewDidLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">viewDidLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token comment">//create tableview..</span>
        <span class="token keyword">let</span> noteList <span class="token operator">=</span> <span class="token punctuation">[</span>
          <span class="token class-name">Note</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">,</span> content<span class="token punctuation">:</span><span class="token string-literal"><span class="token string">&quot;0&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token class-name">Note</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token punctuation">:</span><span class="token string-literal"><span class="token string">&quot;1&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>dataSource <span class="token operator">=</span> <span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">updateData</span><span class="token punctuation">(</span>noteList<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
	<span class="token comment">//更新数据的步骤</span>
	<span class="token comment">//1. 创建空的 snapshot</span>
	<span class="token comment">//2. 填充 snapshort 数据</span>
	<span class="token comment">//3. apply() snapshot </span>
    <span class="token keyword">func</span> <span class="token function-definition function">updateData</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> noteList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">Note</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> snapshot <span class="token operator">=</span> <span class="token class-name">NSDiffableDataSourceSnapshot</span><span class="token operator">&lt;</span><span class="token class-name">Section</span><span class="token punctuation">,</span> <span class="token class-name">Note</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      snapshot<span class="token punctuation">.</span><span class="token function">appendSections</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">.</span>today<span class="token punctuation">]</span><span class="token punctuation">)</span>
      snapshot<span class="token punctuation">.</span><span class="token function">appendItems</span><span class="token punctuation">(</span>noteList<span class="token punctuation">)</span>
      <span class="token keyword">self</span><span class="token punctuation">.</span>dataSource<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>snapshot<span class="token punctuation">,</span> animatingDifferences<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> completion<span class="token punctuation">:</span> <span class="token nil constant">nil</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
	<span class="token comment">//获取 UITableViewDiffableDataSource </span>
    <span class="token keyword">func</span> <span class="token function-definition function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">UITableViewDiffableDataSource</span><span class="token operator">&lt;</span><span class="token class-name">Section</span><span class="token punctuation">,</span><span class="token class-name">Note</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">UITableViewDiffableDataSource</span><span class="token punctuation">(</span>tableView<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>tableView<span class="token punctuation">)</span> <span class="token punctuation">{</span> tableView<span class="token punctuation">,</span> index<span class="token punctuation">,</span> note <span class="token keyword">in</span>
            <span class="token keyword">let</span> cell <span class="token operator">=</span> <span class="token class-name">UITableViewCell</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>style<span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">,</span> reuseIdentifier<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;cell&quot;</span></span><span class="token punctuation">)</span>
            cell<span class="token punctuation">.</span>textLabel<span class="token operator">?</span><span class="token punctuation">.</span>text <span class="token operator">=</span> note<span class="token punctuation">.</span>content
            <span class="token keyword">return</span> cell
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>代码说明</p> <ol><li><p><code>UITableViewDiffableDataSource</code> 的创建过程是绑定了 tableView 和一个提供 cell 的回调（cell provider），回调中创建 <code>UITableViewCell</code> 部分和原来 <code>UITableViewDataSource</code> 数据代理方法里的 cellForRow 方法里的逻辑是一样的，而回调的参数提供了必要的数据部分，不用我们再去通过 indexPath 去找数据了。</p></li> <li><p><code>UITableViewDiffableDataSource</code> 的另外一个最重要的作用是 apply snapshot，这是例子中 <code>UITableViewDiffableDataSource</code> 和 <code>NSDiffableDataSourceSnapshot</code> 唯一交互的地方。这也就是我们说的 <code>UITableViewDiffableDataSource</code> 用来管理数据。如果我们有多份 snapshot，我们可以通过 <code>UITableViewDiffableDataSource</code> 来管理到底哪个 snapshot 展示到视图。</p></li> <li><p>不同的视图使用的数据源类型并不一样， 比如对于 <code>UICollectionView</code> 来说，它的数据源提供类是 <code>UICollectionViewDiffableDataSource</code>。但是所有列表视图用到的快照(snapshot)类型是一样的，都是 <code>NSDiffableDataSourceSnapshot</code>。</p></li> <li><p>列表视图更新的基本套路就是三步走:</p> <ol><li>创建(create)空快照</li> <li>填充(populate)空快照</li> <li>应用(apply)空快照</li></ol></li> <li><p><code>NSDiffableDataSourceSnapshot</code> 对于数据源模型的要求，我们之前说 <code>NSDiffableDataSourceSnapshot</code> 是由 sections 和 items 组成的，所以就是明确 sections 和 items 的类型。<code>NSDiffableDataSourceSnapshot</code> 官方声明如下：</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">class</span> <span class="token class-name">UITableViewDiffableDataSource</span><span class="token operator">&lt;</span><span class="token class-name">SectionIdentifierType</span><span class="token punctuation">,</span> <span class="token class-name">ItemIdentifierType</span><span class="token operator">&gt;</span> <span class="token punctuation">:</span> <span class="token class-name">NSObject</span> <span class="token keyword">where</span> <span class="token class-name">SectionIdentifierType</span> <span class="token punctuation">:</span> <span class="token class-name">Hashable</span><span class="token punctuation">,</span> <span class="token class-name">SectionIdentifierType</span> <span class="token punctuation">:</span> <span class="token class-name">Sendable</span><span class="token punctuation">,</span> <span class="token class-name">ItemIdentifierType</span> <span class="token punctuation">:</span> <span class="token class-name">Hashable</span><span class="token punctuation">,</span> <span class="token class-name">ItemIdentifierType</span> <span class="token punctuation">:</span> <span class="token class-name">Sendable</span>
</code></pre></div><p><code>SectionIdentifierType</code>, <code>ItemIdentifierType</code> 都必须遵守 <code>Hashable</code> 协议，上面例子中我们 <code>SectionIdentifierType</code> 使用的枚举类型(没有关联值)，自动支持枚举，<code>ItemIdentifierType</code> 使用的结构体，结构体的属性都默认支持 <code>Hashable</code>，所以结构体也默认支持。</p> <blockquote><p><a href="https://developer.apple.com/documentation/swift/hashable" target="_blank" rel="noopener noreferrer">Hashable 说明:<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> When you define an enumeration without associated values, it gains <code>Hashable</code>
 conformance automatically。For structs whose stored properties are all <code>Hashable</code>
the compiler is able to provide an implementation of <code>hash(into:)</code>
 automatically.</p></blockquote> <p>同时也要求 <code>SectionIdentifierType</code>, <code>ItemIdentifierType</code> 两个类都必须有唯一 id，这是diff算法的基本要求。</p></li></ol> <p><code>UITableView</code> 变化数据源提供方式不影响  <code>UITableViewDelegate</code> 的实现，比如要实现点击cell打印文字的方法我们可以使用如下的方式，框架提供了 indexPath 转 Item 的方法，所以还是挺方便的。</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">private</span> <span class="token keyword">var</span> dataSource<span class="token punctuation">:</span><span class="token class-name">UITableViewDiffableDataSource</span><span class="token operator">&lt;</span><span class="token class-name">Section</span><span class="token punctuation">,</span> <span class="token class-name">Note</span><span class="token operator">&gt;!</span>
<span class="token keyword">func</span> <span class="token function-definition function">tableView</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> tableView<span class="token punctuation">:</span> <span class="token class-name">UITableView</span><span class="token punctuation">,</span> didSelectRowAt indexPath<span class="token punctuation">:</span> <span class="token class-name">IndexPath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> item <span class="token operator">=</span> dataSource<span class="token punctuation">.</span><span class="token function">itemIdentifier</span><span class="token punctuation">(</span><span class="token keyword">for</span><span class="token punctuation">:</span> indexPath<span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;content </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">item<span class="token operator">?</span><span class="token punctuation">.</span>content</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>差量数据源的方式让开发者摆脱了自己去做 diff 的枯燥的工作，更加专心到上层业务逻辑，再也不必担心数据源和视图操作不一致的问题以及动画效果的问题。比较适用列表数据经常变化的场景，如果列表纯作为一个展示的功能的话，两种数据源提供方式都可以的。</p> <p>参考地址:</p> <ol><li><a href="https://developer.apple.com/videos/play/wwdc2019/220/" target="_blank" rel="noopener noreferrer">WWDC2019-Advances in UI Data Sources<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://developer.apple.com/videos/play/wwdc2020/10045" target="_blank" rel="noopener noreferrer">WWDC2020-Advances in diffable data sources<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://juejin.cn/post/7054779926720806942" target="_blank" rel="noopener noreferrer">掘金-iOS DiffableDataSource的使用<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.avanderlee.com/swift/diffable-data-sources-adoption/" target="_blank" rel="noopener noreferrer">Diffable Data Sources Adoption with Ease<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ol> <!----></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#普通数据源方式" title="普通数据源方式">普通数据源方式</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#差量数据源方式" title="差量数据源方式">差量数据源方式</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#demo" title="Demo">Demo</a></div></div></div></div> <footer class="footer" data-v-3d9deeb8><div class="footer-left-wrap" data-v-3d9deeb8><ul class="contact" data-v-3d9deeb8></ul></div> <div class="footer-right-wrap" data-v-3d9deeb8><ul class="copyright" data-v-3d9deeb8></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.2cedb1d8.js" defer></script><script src="/assets/js/29.309f71c0.js" defer></script><script src="/assets/js/3.e78f3171.js" defer></script><script src="/assets/js/105.57832bba.js" defer></script>
  </body>
</html>
