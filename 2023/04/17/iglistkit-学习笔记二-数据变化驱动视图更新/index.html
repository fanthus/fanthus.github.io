<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>IGListKit 学习笔记二-数据变化驱动视图更新 | fanthus&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/logo.jpg">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <script async="true" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3512514942188386" crossorigin="anonymous"></script>
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-MEH5F43SVB"></script>
    <script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-MEH5F43SVB');</script>
    <script>console.log("my name is fanthus, hope my blog bring new ideas to you.");</script>
    <meta name="description" content="IGListKit 的数据变更后刷新是通过 diff 算法比较数据变更差异，然后在界面上应用这些差异。

数据刷新主要有两种方式 performUpdates 以及 reloadDatas。

performUpdates 和 reloadData 的区别

performUpdates

基于 UICollectionView 的 `performBatchUpdates: ...">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/0.styles.232103a7.css" as="style"><link rel="preload" href="/assets/js/app.2cedb1d8.js" as="script"><link rel="preload" href="/assets/js/29.309f71c0.js" as="script"><link rel="preload" href="/assets/js/3.e78f3171.js" as="script"><link rel="preload" href="/assets/js/111.372545eb.js" as="script"><link rel="prefetch" href="/assets/js/10.4cd31608.js"><link rel="prefetch" href="/assets/js/100.3443112a.js"><link rel="prefetch" href="/assets/js/101.e0037931.js"><link rel="prefetch" href="/assets/js/102.f4c7589f.js"><link rel="prefetch" href="/assets/js/103.0df46cd4.js"><link rel="prefetch" href="/assets/js/104.17a0ee44.js"><link rel="prefetch" href="/assets/js/105.57832bba.js"><link rel="prefetch" href="/assets/js/106.680eda55.js"><link rel="prefetch" href="/assets/js/107.410f297e.js"><link rel="prefetch" href="/assets/js/108.fb80d3ad.js"><link rel="prefetch" href="/assets/js/109.699c7520.js"><link rel="prefetch" href="/assets/js/11.7393e510.js"><link rel="prefetch" href="/assets/js/110.d4f0aca9.js"><link rel="prefetch" href="/assets/js/112.bc127403.js"><link rel="prefetch" href="/assets/js/113.414e616f.js"><link rel="prefetch" href="/assets/js/114.d8c4fe8d.js"><link rel="prefetch" href="/assets/js/115.279ec90c.js"><link rel="prefetch" href="/assets/js/116.c60ac54a.js"><link rel="prefetch" href="/assets/js/117.15c04390.js"><link rel="prefetch" href="/assets/js/118.f9d8228c.js"><link rel="prefetch" href="/assets/js/119.719d77b5.js"><link rel="prefetch" href="/assets/js/12.c35fa779.js"><link rel="prefetch" href="/assets/js/120.cf48f47a.js"><link rel="prefetch" href="/assets/js/121.4aad0ac7.js"><link rel="prefetch" href="/assets/js/122.15f2b5ef.js"><link rel="prefetch" href="/assets/js/123.4dea98c9.js"><link rel="prefetch" href="/assets/js/124.0152be90.js"><link rel="prefetch" href="/assets/js/125.ecf56222.js"><link rel="prefetch" href="/assets/js/126.50fe6660.js"><link rel="prefetch" href="/assets/js/127.28abe492.js"><link rel="prefetch" href="/assets/js/128.48a0862c.js"><link rel="prefetch" href="/assets/js/129.77b2b203.js"><link rel="prefetch" href="/assets/js/13.35658260.js"><link rel="prefetch" href="/assets/js/130.d0ef4952.js"><link rel="prefetch" href="/assets/js/131.55b00f57.js"><link rel="prefetch" href="/assets/js/14.4e33e6a2.js"><link rel="prefetch" href="/assets/js/15.345a84a1.js"><link rel="prefetch" href="/assets/js/16.3d596c76.js"><link rel="prefetch" href="/assets/js/17.3e2e1a7a.js"><link rel="prefetch" href="/assets/js/18.c8e88810.js"><link rel="prefetch" href="/assets/js/19.f0e3f187.js"><link rel="prefetch" href="/assets/js/20.cb5c866b.js"><link rel="prefetch" href="/assets/js/21.b83191ac.js"><link rel="prefetch" href="/assets/js/22.bea483cb.js"><link rel="prefetch" href="/assets/js/23.3877c278.js"><link rel="prefetch" href="/assets/js/24.0524a7e6.js"><link rel="prefetch" href="/assets/js/25.3f3c78fe.js"><link rel="prefetch" href="/assets/js/26.3f72710f.js"><link rel="prefetch" href="/assets/js/27.f35bb8e9.js"><link rel="prefetch" href="/assets/js/28.5e29b9fe.js"><link rel="prefetch" href="/assets/js/30.a60200be.js"><link rel="prefetch" href="/assets/js/31.c2accd33.js"><link rel="prefetch" href="/assets/js/32.41be2bbb.js"><link rel="prefetch" href="/assets/js/33.8447af66.js"><link rel="prefetch" href="/assets/js/34.122a4606.js"><link rel="prefetch" href="/assets/js/35.fa9f0fe8.js"><link rel="prefetch" href="/assets/js/36.ffc459c1.js"><link rel="prefetch" href="/assets/js/37.12421aeb.js"><link rel="prefetch" href="/assets/js/38.66884bf5.js"><link rel="prefetch" href="/assets/js/39.4901c209.js"><link rel="prefetch" href="/assets/js/4.41416bc4.js"><link rel="prefetch" href="/assets/js/40.726f0f90.js"><link rel="prefetch" href="/assets/js/41.1466329e.js"><link rel="prefetch" href="/assets/js/42.ad110115.js"><link rel="prefetch" href="/assets/js/43.42f6c87f.js"><link rel="prefetch" href="/assets/js/44.38a3ffda.js"><link rel="prefetch" href="/assets/js/45.54729d58.js"><link rel="prefetch" href="/assets/js/46.688f019f.js"><link rel="prefetch" href="/assets/js/47.069217c5.js"><link rel="prefetch" href="/assets/js/48.0227b0c3.js"><link rel="prefetch" href="/assets/js/49.7a3d3511.js"><link rel="prefetch" href="/assets/js/5.9be8c1b7.js"><link rel="prefetch" href="/assets/js/50.35d1d592.js"><link rel="prefetch" href="/assets/js/51.7e7b901a.js"><link rel="prefetch" href="/assets/js/52.f693d3ed.js"><link rel="prefetch" href="/assets/js/53.c4c4d1a2.js"><link rel="prefetch" href="/assets/js/54.eab66332.js"><link rel="prefetch" href="/assets/js/55.7e80dbb1.js"><link rel="prefetch" href="/assets/js/56.1041c5f3.js"><link rel="prefetch" href="/assets/js/57.a7c1bc68.js"><link rel="prefetch" href="/assets/js/58.c07c376a.js"><link rel="prefetch" href="/assets/js/59.8b20d651.js"><link rel="prefetch" href="/assets/js/6.1724a888.js"><link rel="prefetch" href="/assets/js/60.417e91a2.js"><link rel="prefetch" href="/assets/js/61.4db451fd.js"><link rel="prefetch" href="/assets/js/62.8f0bdaac.js"><link rel="prefetch" href="/assets/js/63.911f46a9.js"><link rel="prefetch" href="/assets/js/64.60deeb3e.js"><link rel="prefetch" href="/assets/js/65.201e0e08.js"><link rel="prefetch" href="/assets/js/66.248f04bf.js"><link rel="prefetch" href="/assets/js/67.500ae9a1.js"><link rel="prefetch" href="/assets/js/68.a95fd5e5.js"><link rel="prefetch" href="/assets/js/69.24aaae86.js"><link rel="prefetch" href="/assets/js/7.934b58e4.js"><link rel="prefetch" href="/assets/js/70.ec2f6ce6.js"><link rel="prefetch" href="/assets/js/71.b454fdd6.js"><link rel="prefetch" href="/assets/js/72.74299778.js"><link rel="prefetch" href="/assets/js/73.3cd8645d.js"><link rel="prefetch" href="/assets/js/74.d5accf5c.js"><link rel="prefetch" href="/assets/js/75.2d01044b.js"><link rel="prefetch" href="/assets/js/76.f31f74e1.js"><link rel="prefetch" href="/assets/js/77.3b826970.js"><link rel="prefetch" href="/assets/js/78.b7547141.js"><link rel="prefetch" href="/assets/js/79.5d0ef470.js"><link rel="prefetch" href="/assets/js/8.2a195ce5.js"><link rel="prefetch" href="/assets/js/80.0b0b5a17.js"><link rel="prefetch" href="/assets/js/81.24f2588e.js"><link rel="prefetch" href="/assets/js/82.f8c84af4.js"><link rel="prefetch" href="/assets/js/83.7fff9a1b.js"><link rel="prefetch" href="/assets/js/84.c0208c2c.js"><link rel="prefetch" href="/assets/js/85.e363b25e.js"><link rel="prefetch" href="/assets/js/86.5837e9f1.js"><link rel="prefetch" href="/assets/js/87.3e2f38a0.js"><link rel="prefetch" href="/assets/js/88.d3958f6f.js"><link rel="prefetch" href="/assets/js/89.ec3fdee0.js"><link rel="prefetch" href="/assets/js/9.c0adb174.js"><link rel="prefetch" href="/assets/js/90.94654c43.js"><link rel="prefetch" href="/assets/js/91.76b106e7.js"><link rel="prefetch" href="/assets/js/92.69e5bf8b.js"><link rel="prefetch" href="/assets/js/93.3d4a8f29.js"><link rel="prefetch" href="/assets/js/94.202d1036.js"><link rel="prefetch" href="/assets/js/95.002d5790.js"><link rel="prefetch" href="/assets/js/96.044893c5.js"><link rel="prefetch" href="/assets/js/97.c6dec31d.js"><link rel="prefetch" href="/assets/js/98.20673f07.js"><link rel="prefetch" href="/assets/js/99.fa4a2cf2.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.91ff346d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.232103a7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">fanthus's blog </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/tag/" class="nav-link">Tags</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">fanthus's blog </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">Tags</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        IGListKit 学习笔记二-数据变化驱动视图更新
      </h1> <div class="post-meta"><!----> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2023-04-17T14:59:19.000Z">
      Mon Apr 17 2023
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-42ccfcd5><a href="/tag/IGListKit" data-v-42ccfcd5><span data-v-42ccfcd5>IGListKit</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/tag/iOS" data-v-42ccfcd5><span data-v-42ccfcd5>iOS</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><p>IGListKit 的数据变更后刷新是通过 diff 算法比较数据变更差异，然后在界面上应用这些差异。</p> <p>数据刷新主要有两种方式 performUpdates 以及 reloadDatas。</p> <h2 id="performupdates-和-reloaddata-的区别"><a href="#performupdates-和-reloaddata-的区别" class="header-anchor">#</a> performUpdates 和 reloadData 的区别</h2> <p><code>performUpdates</code></p> <ul><li>基于 <code>UICollectionView</code> 的 <code>performBatchUpdates:completion:</code> API</li> <li>使用 diff 算法只会更新实际变动的数据和界面部分，非变动部分不会刷新。这可以大幅提高性能。</li> <li>有平滑的动画效果,用户体验更好。</li></ul> <p><code>reloadData</code></p> <ul><li>基于 <code>UICollectionView</code> 的 <code>reloadData</code> API</li> <li>会完全刷新列表数据源和界面，并不会去进行 diff 性能较差。</li> <li>没有动画,界面会突然刷新,用户体验差。</li></ul> <p>总结下来就是</p> <ul><li>如果数据源发生大规模变化,使用 <code>reloadData</code> 会简便一些，官方的 QA 有<a href="https://instagram.github.io/IGListKit/best-practices-and-faq.html" target="_blank" rel="noopener noreferrer">提到<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</li> <li>如果数据源只有局部变动，强烈推荐使用 <code>performUpdates</code>，这可以达到最佳的性能和用户体验。</li></ul> <h2 id="performupdates-闪退问题"><a href="#performupdates-闪退问题" class="header-anchor">#</a> performUpdates 闪退问题</h2> <p>但是在实际使用过程中 performUpdates 会闪退？官方的 issue 区也有类似的问题</p> <p><a href="https://github.com/Instagram/IGListKit/issues/799" target="_blank" rel="noopener noreferrer">https://github.com/Instagram/IGListKit/issues/799<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>闪退内容大概意思就是更新前后的同一个 section 的 items 数量前后不一致导致更新无效。</p> <blockquote><p>IGListKitDemo[29744:591638] [UICollectionView] Performing reloadData as a fallback — Invalid update: invalid number of items in section 0. The number of items contained in an existing section after the update (2) must be equal to the number of items contained in that section before the update (1), plus or minus the number of items inserted or deleted from that section (0 inserted, 0 deleted) and plus or minus the number of items moved into or out of that section (0 moved in, 0 moved out). Collection view: &lt;UICollectionView: 0x7fc50b816400; …. &gt;</p></blockquote> <p>出现这个问题的主要原因是同一个数据变化导致它对应的 section items 数量发生变化，<code>UICollectionView</code> <code>performUpdates</code> 前后数量不一致导致 <code>UICollectionView</code> 刷新机制出现了问题。</p> <p>什么场景下会出现这个问题？在 IGListKit 里面如果根据数据(model)的属性去判断 section items 的数量。如果对应属性修改引起了 section items 的数量变化，此时执行 <code>performUpdates</code> 就能触发上面的崩溃。</p> <p>这里需要注意的点是，如何定义同一个数据？我们先来看看 IGListKit 底层使用的 diff 算法的变现。</p> <h2 id="diff-算法的具体表现"><a href="#diff-算法的具体表现" class="header-anchor">#</a> diff 算法的具体表现</h2> <p>这里不打算介绍 diff 算法的原理，如果感兴趣的话可以去网上搜 IGListKit 的 diff 算法，我们现在只是看下 diff 算法的具体表现。</p> <p>结合学习笔记一的 Feed 的定义，我们修改了下 <code>isEqual</code> 的算法实现，增加了 <code>feed.name</code> 的判断</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">extension</span> <span class="token class-name">Feed</span><span class="token punctuation">:</span> <span class="token class-name">ListDiffable</span> <span class="token punctuation">{</span>
    <span class="token keyword">func</span> <span class="token function-definition function">diffIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">NSObjectProtocol</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string-literal"><span class="token string">&quot;</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation"><span class="token class-name">String</span><span class="token punctuation">(</span>describing<span class="token punctuation">:</span> id<span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&quot;</span></span> <span class="token keyword">as</span> <span class="token class-name">NSObjectProtocol</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">func</span> <span class="token function-definition function">isEqual</span><span class="token punctuation">(</span>toDiffableObject object<span class="token punctuation">:</span> <span class="token class-name">ListDiffable</span><span class="token operator">?</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Bool</span> <span class="token punctuation">{</span>
        <span class="token keyword">guard</span> <span class="token keyword">let</span> feed <span class="token operator">=</span> object <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">Feed</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
        <span class="token keyword">return</span> feed<span class="token punctuation">.</span><span class="token function">diffIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqual</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">diffIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> feed<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token keyword">self</span><span class="token punctuation">.</span>name
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>具体的数据构建和 diff 结果如下</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">func</span> <span class="token function-definition function">buildOldFeeds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">[</span><span class="token class-name">Feed</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> oldFeeds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token class-name">Feed</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> feed1 <span class="token operator">=</span> <span class="token class-name">Feed</span><span class="token punctuation">.</span><span class="token function">buildFeedWithId</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;OldWang&quot;</span></span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> feed2 <span class="token operator">=</span> <span class="token class-name">Feed</span><span class="token punctuation">.</span><span class="token function">buildFeedWithId</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;OldFan&quot;</span></span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> feed3 <span class="token operator">=</span> <span class="token class-name">Feed</span><span class="token punctuation">.</span><span class="token function">buildFeedWithId</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;OldHuo&quot;</span></span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> feed4 <span class="token operator">=</span> <span class="token class-name">Feed</span><span class="token punctuation">.</span><span class="token function">buildFeedWithId</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;OldDao&quot;</span></span><span class="token punctuation">)</span>
    oldFeeds<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>contentsOf<span class="token punctuation">:</span> <span class="token punctuation">[</span>feed1<span class="token punctuation">,</span> feed2<span class="token punctuation">,</span> feed3<span class="token punctuation">,</span> feed4<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> oldFeeds
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function-definition function">buildNewFeeds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">[</span><span class="token class-name">Feed</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> newFeeds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token class-name">Feed</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> feed5 <span class="token operator">=</span> <span class="token class-name">Feed</span><span class="token punctuation">.</span><span class="token function">buildFeedWithId</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;OldFan1&quot;</span></span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> feed6 <span class="token operator">=</span> <span class="token class-name">Feed</span><span class="token punctuation">.</span><span class="token function">buildFeedWithId</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;NewWang&quot;</span></span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> feed7 <span class="token operator">=</span> <span class="token class-name">Feed</span><span class="token punctuation">.</span><span class="token function">buildFeedWithId</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;OldWang&quot;</span></span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> feed8 <span class="token operator">=</span> <span class="token class-name">Feed</span><span class="token punctuation">.</span><span class="token function">buildFeedWithId</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;OldDao22&quot;</span></span><span class="token punctuation">)</span>
    newFeeds<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>contentsOf<span class="token punctuation">:</span> <span class="token punctuation">[</span>feed5<span class="token punctuation">,</span> feed6<span class="token punctuation">,</span> feed7<span class="token punctuation">,</span> feed8<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> newFeeds
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function-definition function">compareDiff</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> oldFeeds <span class="token operator">=</span> <span class="token function">buildOldFeeds</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> newFeeds <span class="token operator">=</span> <span class="token function">buildNewFeeds</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> results <span class="token operator">=</span> <span class="token class-name">ListDiff</span><span class="token punctuation">(</span>oldArray<span class="token punctuation">:</span> oldFeeds<span class="token punctuation">,</span> newArray<span class="token punctuation">:</span> newFeeds<span class="token punctuation">,</span> option<span class="token punctuation">:</span> <span class="token punctuation">.</span>equality<span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;inserts </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">results<span class="token punctuation">.</span>inserts</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">\ndeletes </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">results<span class="token punctuation">.</span>deletes</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">\nupdates </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">results<span class="token punctuation">.</span>updates</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">\nmoves </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">results<span class="token punctuation">.</span>moves</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
    results<span class="token punctuation">.</span>inserts<span class="token punctuation">.</span>forEach <span class="token punctuation">{</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;insert </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">newFeeds<span class="token punctuation">[</span><span class="token short-argument">$0</span><span class="token punctuation">]</span></span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&quot;</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    results<span class="token punctuation">.</span>deletes<span class="token punctuation">.</span>forEach <span class="token punctuation">{</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;delete </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">oldFeeds<span class="token punctuation">[</span><span class="token short-argument">$0</span><span class="token punctuation">]</span></span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&quot;</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    results<span class="token punctuation">.</span>updates<span class="token punctuation">.</span>forEach <span class="token punctuation">{</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;update index </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation"><span class="token short-argument">$0</span></span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&quot;</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    results<span class="token punctuation">.</span>updates<span class="token punctuation">.</span>forEach <span class="token punctuation">{</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;update from </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">oldFeeds<span class="token punctuation">[</span><span class="token short-argument">$0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string"> to </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">newFeeds<span class="token punctuation">[</span><span class="token short-argument">$0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&quot;</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">&gt;&gt;&gt;</span> 结果
inserts <span class="token number">1</span> indexes
deletes <span class="token number">1</span> indexes
updates <span class="token number">2</span> indexes
moves <span class="token punctuation">[</span><span class="token operator">&lt;</span><span class="token class-name">IGListMoveIndex</span> <span class="token number">0x282c61be0</span><span class="token punctuation">;</span> from<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">;</span> to<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token class-name">IGListMoveIndex</span> <span class="token number">0x282c61c20</span><span class="token punctuation">;</span> from<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span> to<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>
insert <span class="token class-name">Optional</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;NewWang&quot;</span></span><span class="token punctuation">)</span>
delete <span class="token class-name">Optional</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;OldHuo&quot;</span></span><span class="token punctuation">)</span>
update index <span class="token number">1</span>
update index <span class="token number">3</span>
</code></pre></div><p>里面基本上涵盖了数据变化的各种情况，可以看到</p> <ul><li><strong>insert 和 delete 的判断依据是 id 的变化</strong>。即只要有 id 的变化就有对应的 insert 和 delete 数据增减变化。</li> <li><strong>updates 的判断依据是 isEqual 中的判断逻辑</strong>，比如上面数组变化前后 id 为 4 的 Feed，如果在 Feed 的 isEqual 方法中不引入 name 这个变量的话，就不会检查到数据的变化。</li></ul> <p>上面的的场景中，如果需要将 newFeeds 中的更新的数据赋给 oldFeeds，那需要先通过 results.updates 下标获取 oldFeeds 里的数据，然后通过 id 匹配找到 newFeeds 里对应的 Feed，通过 Feed 直接赋值的方式更新。</p> <p>insert 和 delete 的概念比较好理解，这里重点关注下 update 的场景，下面这个场景在实际开发中经常会遇到，比如给帖子点赞，更新评论数等，其实就是改变了列表元素中某个实例的属性，<strong>如果这些属性不在 isEqual 的判断逻辑里，则直接进行 performUpdates 后是没有办法 diff 出任何东西的</strong>，因为比较前后的列表是一样的。</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">func</span> <span class="token function-definition function">buildOldFeeds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">[</span><span class="token class-name">Feed</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> oldFeeds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token class-name">Feed</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    oldFeeds<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">Feed</span><span class="token punctuation">.</span><span class="token function">buildFeedWithId</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;OldWang&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> oldFeeds
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function-definition function">buildNewFeeds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">[</span><span class="token class-name">Feed</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> newFeeds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token class-name">Feed</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    newFeeds<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">Feed</span><span class="token punctuation">.</span><span class="token function">buildFeedWithId</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;OldFan&quot;</span></span><span class="token punctuation">,</span> content<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;xxxx&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> newFeeds
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function-definition function">compareDiff</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> oldFeeds <span class="token operator">=</span> <span class="token function">buildOldFeeds</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    oldFeeds<span class="token punctuation">.</span>first<span class="token operator">?</span><span class="token punctuation">.</span>content <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;xxx&quot;</span></span>
	<span class="token keyword">let</span> newFeeds <span class="token operator">=</span> oldFeeds
    <span class="token keyword">let</span> results <span class="token operator">=</span> <span class="token class-name">ListDiff</span><span class="token punctuation">(</span>oldArray<span class="token punctuation">:</span> oldFeeds<span class="token punctuation">,</span> newArray<span class="token punctuation">:</span> newFeeds<span class="token punctuation">,</span> option<span class="token punctuation">:</span> <span class="token punctuation">.</span>equality<span class="token punctuation">)</span>
	<span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;inserts </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">results<span class="token punctuation">.</span>inserts</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">\ndeletes </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">results<span class="token punctuation">.</span>deletes</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">\nupdates </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">results<span class="token punctuation">.</span>updates</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">\nmoves </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">results<span class="token punctuation">.</span>moves</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token operator">&gt;&gt;&gt;</span>
inserts <span class="token number">0</span> indexes
deletes <span class="token number">0</span> indexes
updates <span class="token number">0</span> indexes
moves <span class="token punctuation">[</span><span class="token punctuation">]</span>
</code></pre></div><h2 id="回到-performupdates-闪退的问题"><a href="#回到-performupdates-闪退的问题" class="header-anchor">#</a> 回到 performUpdates 闪退的问题</h2> <p>假设我们有下面这段场景，一个 Feed 实例 contents 属性内容填充后会影响 Feed 对应的 section items 的变化。</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">extension</span> <span class="token class-name">Feed</span><span class="token punctuation">:</span> <span class="token class-name">ListDiffable</span> <span class="token punctuation">{</span>
    <span class="token keyword">func</span> <span class="token function-definition function">diffIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">NSObjectProtocol</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string-literal"><span class="token string">&quot;</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation"><span class="token class-name">String</span><span class="token punctuation">(</span>describing<span class="token punctuation">:</span> id<span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&quot;</span></span> <span class="token keyword">as</span> <span class="token class-name">NSObjectProtocol</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">func</span> <span class="token function-definition function">isEqual</span><span class="token punctuation">(</span>toDiffableObject object<span class="token punctuation">:</span> <span class="token class-name">ListDiffable</span><span class="token operator">?</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Bool</span> <span class="token punctuation">{</span>
        <span class="token keyword">guard</span> <span class="token keyword">let</span> feed <span class="token operator">=</span> object <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">Feed</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
        <span class="token keyword">return</span> feed<span class="token punctuation">.</span><span class="token function">diffIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqual</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">diffIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> feed<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token keyword">self</span><span class="token punctuation">.</span>name
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function-definition function">buildOldFeeds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">[</span><span class="token class-name">Feed</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> oldFeeds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token class-name">Feed</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">let</span> feed1 <span class="token operator">=</span> <span class="token class-name">Feed</span><span class="token punctuation">.</span><span class="token function">buildFeedWithId</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;OldWang&quot;</span></span><span class="token punctuation">)</span>
	oldFeeds<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>contentsOf<span class="token punctuation">:</span> <span class="token punctuation">[</span>feed1<span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> oldFeeds
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function-definition function">buildNewFeeds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">[</span><span class="token class-name">Feed</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> newFeeds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token class-name">Feed</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">let</span> feed5 <span class="token operator">=</span> <span class="token class-name">Feed</span><span class="token punctuation">.</span><span class="token function">buildFeedWithId</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;OldFan&quot;</span></span><span class="token punctuation">,</span> content<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;xxxx&quot;</span></span><span class="token punctuation">)</span>
	newFeeds<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>feed5<span class="token punctuation">)</span>
	<span class="token keyword">return</span> newFeeds
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function-definition function">mockChangeRefresh</span> <span class="token punctuation">{</span>
	feedList <span class="token operator">=</span> <span class="token function">buildOldFeeds</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	adapter<span class="token punctuation">.</span><span class="token function">reloadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token class-name">DispatchQueue</span><span class="token punctuation">.</span>main<span class="token punctuation">.</span><span class="token function">asyncAfter</span><span class="token punctuation">(</span>deadline<span class="token punctuation">:</span> <span class="token class-name">DispatchTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span><span class="token keyword">weak</span> <span class="token keyword">self</span><span class="token punctuation">]</span> <span class="token keyword">in</span>
    <span class="token keyword">guard</span> <span class="token keyword">let</span> wself <span class="token operator">=</span> <span class="token keyword">self</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span>
		<span class="token comment">//场景一 </span>
		wself<span class="token punctuation">.</span>feedList<span class="token punctuation">.</span>first<span class="token operator">?</span><span class="token punctuation">.</span>content <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;xxxx&quot;</span></span>
		<span class="token comment">//场景二</span>
        wself<span class="token punctuation">.</span>feedList <span class="token operator">=</span> wself<span class="token punctuation">.</span><span class="token function">buildNewFeeds</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        wself<span class="token punctuation">.</span>adapter<span class="token punctuation">.</span><span class="token function">performUpdates</span><span class="token punctuation">(</span>animated<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>以上两种情况都会产生崩溃</p> <ul><li><p>场景一的情况下 section items 在 <code>peformUpdates:</code> 前后的数量不同，而且 section 对应的 data 实例本身是没有发生任何改变，所以引起崩溃。</p></li> <li><p>场景二的情况下是新建了元素，<s>所以会 diff 出来 updates</s>，diff 后的结果也没有任何 updates，同样是会出现崩溃。</p></li></ul> <p>但是如果我们在 <code>ListDiffable</code> 协议的 <code>isEqual</code> 方法中添加 <code>content</code> 的判断如下</p> <div class="language-Swift extra-class"><pre class="language-swift"><code><span class="token keyword">func</span> <span class="token function-definition function">isEqual</span><span class="token punctuation">(</span>toDiffableObject object<span class="token punctuation">:</span> <span class="token class-name">ListDiffable</span><span class="token operator">?</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Bool</span> <span class="token punctuation">{</span>
    <span class="token keyword">guard</span> <span class="token keyword">let</span> feed <span class="token operator">=</span> object <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">Feed</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
    <span class="token keyword">return</span> feed<span class="token punctuation">.</span><span class="token function">diffIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqual</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">diffIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> feed<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token keyword">self</span><span class="token punctuation">.</span>name <span class="token operator">&amp;&amp;</span> feed<span class="token punctuation">.</span>content <span class="token operator">==</span> <span class="token keyword">self</span><span class="token punctuation">.</span>content
<span class="token punctuation">}</span>
</code></pre></div><p>则在场景一下依然崩溃，因为 diff 前后本质上是同一个对象，所以没办法 diff 出差别；但是场景二下是能够 diff 出 <code>updates</code> 的，<strong>所以我们在使用 <code>performUpdates</code> 的时候前后要新建元素实例来触发 diff 算法生效。</strong></p> <blockquote><p><code>IGListAdapter</code> 维护的 <code>sectionMap</code> 在 <code>performUpdates</code> 前并不会干掉真实的列表真实数据，除非用户主动修改列表元素内容。像是上面场景二中那样直接赋新值。可以参考 <code>IGListAdapter</code> 的 <code>performUpdatesAnimated:completion:</code> 方法来查看 diff 算法中的数据来源(from, to)</p></blockquote> <h2 id="performupdates-不生效"><a href="#performupdates-不生效" class="header-anchor">#</a> performUpdates 不生效</h2> <p>有的时候执行 <code>performUpdates</code> 不生效，本质上是没有 diff 算法计算出来的结果中没有任何改变（没有<code>insert</code>，<code>delete</code> 和 <code>update</code>）。这时候有两种原因</p> <p>① 和上面小节中的场景一一样，直接在原实例属性上修改，diff 后没有产生任何修改。</p> <p>② 新建了实例，但是修改的元素并没有出现在 isEqual 方法对比里，导致 diff 后没有任何修改。</p> <p>基本上 <code>performUpdates</code> 不生效就是上面两种 CASE。其实本质上这种场景更应该使用 <code>reloadSections</code> API 。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p><code>performUpdates</code> API 的使用还是需要注意一些事项，最根本的问题还是要搞清楚 diff 算法，以及 IGListKit 是如何维护 diff 算法的双方(from,to)数据的。</p> <p><s>我自己的解决方法就是，修改某个元素属性执行更新的时候，新建元素并执行对应修改，最好该元素实现 copy 协议，这样会比较方便或者考虑使用 <code>IGListBindingSectionController</code></s></p> <p>[2023-08-13 更新] 其实像是上面说的 <code>performUpdates</code> 不生效的这种情况，有几种解决方案</p> <ol><li>直接通过 <code>reloadSecion:</code> 这种 API 去解决</li> <li>是通过使用 <code>IGListBindingSectionController</code> 这种方式实现cell级别的更新</li> <li>在 <code>cell</code> 层面的交互后去直接更新视图状态，同时修改对应model的属性。当 <code>cell</code> 滚出可视区域，重新滚回来执行 <code>cellForItem:</code> 方法的时候，会按照修改后的属性去更新视图状态。</li> <li>最后一种做法才应该考虑通过新建元素然后执行修改属性的方法去实现。</li></ol> <p>参考地址:</p> <ol><li><a href="https://instagram.github.io/IGListKit/modeling-and-binding.html" target="_blank" rel="noopener noreferrer">IGListKit - Modeling and Binding<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://dirtmelon.github.io/posts/iglistkit-second/" target="_blank" rel="noopener noreferrer">IGListKit 的基石 - IGListSectionController<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ol></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#performupdates-和-reloaddata-的区别" title="performUpdates 和 reloadData 的区别">performUpdates 和 reloadData 的区别</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#performupdates-闪退问题" title="performUpdates 闪退问题">performUpdates 闪退问题</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#diff-算法的具体表现" title="diff 算法的具体表现">diff 算法的具体表现</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#回到-performupdates-闪退的问题" title="回到 performUpdates 闪退的问题">回到 performUpdates 闪退的问题</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#performupdates-不生效" title="performUpdates 不生效">performUpdates 不生效</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#总结" title="总结">总结</a></div></div></div></div> <footer class="footer" data-v-3d9deeb8><div class="footer-left-wrap" data-v-3d9deeb8><ul class="contact" data-v-3d9deeb8></ul></div> <div class="footer-right-wrap" data-v-3d9deeb8><ul class="copyright" data-v-3d9deeb8></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.2cedb1d8.js" defer></script><script src="/assets/js/29.309f71c0.js" defer></script><script src="/assets/js/3.e78f3171.js" defer></script><script src="/assets/js/111.372545eb.js" defer></script>
  </body>
</html>
