<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CoreData 学习笔记三+多Context使用介绍 | fanthus&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/logo.jpg">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <script async="true" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3512514942188386" crossorigin="anonymous"></script>
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-MEH5F43SVB"></script>
    <script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-MEH5F43SVB');</script>
    <script>console.log("my name is fanthus, hope my blog bring new ideas to you.");</script>
    <meta name="description" content="这篇文章主要是介绍如何在 CoreData 中使用多个 Context（本文中提到的 Context 都指的是 NSManagedContext）

多 Context 基础概念

CoreData 并不是线程安全的，如果不额外创建线程的话 CoreData 就是一直在主线程运行的。但是有一些情况是需要额外创建线程去进行 CoreData 操作。这时候就要格外注意 `NSManagedObj ...">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/0.styles.232103a7.css" as="style"><link rel="preload" href="/assets/js/app.5c2aadbb.js" as="script"><link rel="preload" href="/assets/js/29.1acae59f.js" as="script"><link rel="preload" href="/assets/js/3.7fe07bf0.js" as="script"><link rel="preload" href="/assets/js/62.20ab782f.js" as="script"><link rel="prefetch" href="/assets/js/10.e6af762e.js"><link rel="prefetch" href="/assets/js/100.67476119.js"><link rel="prefetch" href="/assets/js/101.f5eb858c.js"><link rel="prefetch" href="/assets/js/102.03da866a.js"><link rel="prefetch" href="/assets/js/103.fb86a639.js"><link rel="prefetch" href="/assets/js/104.3cfe1a59.js"><link rel="prefetch" href="/assets/js/105.06df8093.js"><link rel="prefetch" href="/assets/js/106.3b985ff7.js"><link rel="prefetch" href="/assets/js/107.bc3ffbc8.js"><link rel="prefetch" href="/assets/js/108.4b873cd8.js"><link rel="prefetch" href="/assets/js/109.cf2e8bfc.js"><link rel="prefetch" href="/assets/js/11.ec904e86.js"><link rel="prefetch" href="/assets/js/110.d0e1f360.js"><link rel="prefetch" href="/assets/js/111.32710987.js"><link rel="prefetch" href="/assets/js/112.17690a92.js"><link rel="prefetch" href="/assets/js/113.589070d1.js"><link rel="prefetch" href="/assets/js/114.bec863ac.js"><link rel="prefetch" href="/assets/js/115.66decc99.js"><link rel="prefetch" href="/assets/js/116.b3bfe4dc.js"><link rel="prefetch" href="/assets/js/117.75a5a39d.js"><link rel="prefetch" href="/assets/js/118.e0dd863f.js"><link rel="prefetch" href="/assets/js/119.94c2e0bb.js"><link rel="prefetch" href="/assets/js/12.14256cbe.js"><link rel="prefetch" href="/assets/js/120.c8b76def.js"><link rel="prefetch" href="/assets/js/121.dfdfd9b0.js"><link rel="prefetch" href="/assets/js/122.10da6a05.js"><link rel="prefetch" href="/assets/js/123.e9d46721.js"><link rel="prefetch" href="/assets/js/124.577feddf.js"><link rel="prefetch" href="/assets/js/125.8129b423.js"><link rel="prefetch" href="/assets/js/126.c20f17ba.js"><link rel="prefetch" href="/assets/js/127.7e1c5ded.js"><link rel="prefetch" href="/assets/js/128.5d4e17c0.js"><link rel="prefetch" href="/assets/js/129.f1c8af0e.js"><link rel="prefetch" href="/assets/js/13.6af70c38.js"><link rel="prefetch" href="/assets/js/14.95f777b8.js"><link rel="prefetch" href="/assets/js/15.9c1287ff.js"><link rel="prefetch" href="/assets/js/16.a57aacc5.js"><link rel="prefetch" href="/assets/js/17.5c124641.js"><link rel="prefetch" href="/assets/js/18.6db94c74.js"><link rel="prefetch" href="/assets/js/19.60cf2d9c.js"><link rel="prefetch" href="/assets/js/20.08713c1b.js"><link rel="prefetch" href="/assets/js/21.5eadef54.js"><link rel="prefetch" href="/assets/js/22.66422fed.js"><link rel="prefetch" href="/assets/js/23.739fb024.js"><link rel="prefetch" href="/assets/js/24.c76333d1.js"><link rel="prefetch" href="/assets/js/25.8b10e134.js"><link rel="prefetch" href="/assets/js/26.cfba7153.js"><link rel="prefetch" href="/assets/js/27.72eb7481.js"><link rel="prefetch" href="/assets/js/28.6dcef05c.js"><link rel="prefetch" href="/assets/js/30.2b7c71b4.js"><link rel="prefetch" href="/assets/js/31.5ca92641.js"><link rel="prefetch" href="/assets/js/32.8daba902.js"><link rel="prefetch" href="/assets/js/33.6edbf98d.js"><link rel="prefetch" href="/assets/js/34.84367f88.js"><link rel="prefetch" href="/assets/js/35.85b0ec62.js"><link rel="prefetch" href="/assets/js/36.6cf4ed41.js"><link rel="prefetch" href="/assets/js/37.ee892674.js"><link rel="prefetch" href="/assets/js/38.b7997b04.js"><link rel="prefetch" href="/assets/js/39.90e0d74a.js"><link rel="prefetch" href="/assets/js/4.03934060.js"><link rel="prefetch" href="/assets/js/40.dfc8ad6a.js"><link rel="prefetch" href="/assets/js/41.b60c8046.js"><link rel="prefetch" href="/assets/js/42.77c1c836.js"><link rel="prefetch" href="/assets/js/43.c9d4221c.js"><link rel="prefetch" href="/assets/js/44.6348d9cc.js"><link rel="prefetch" href="/assets/js/45.126bc7fe.js"><link rel="prefetch" href="/assets/js/46.4a3e70e0.js"><link rel="prefetch" href="/assets/js/47.67a75c47.js"><link rel="prefetch" href="/assets/js/48.83f0f7f0.js"><link rel="prefetch" href="/assets/js/49.f7dc76c9.js"><link rel="prefetch" href="/assets/js/5.543a8f29.js"><link rel="prefetch" href="/assets/js/50.e7cc6057.js"><link rel="prefetch" href="/assets/js/51.adabfc4f.js"><link rel="prefetch" href="/assets/js/52.e28c8d20.js"><link rel="prefetch" href="/assets/js/53.13d2e30c.js"><link rel="prefetch" href="/assets/js/54.c393a991.js"><link rel="prefetch" href="/assets/js/55.460bb0db.js"><link rel="prefetch" href="/assets/js/56.2d1300fd.js"><link rel="prefetch" href="/assets/js/57.6ea9c916.js"><link rel="prefetch" href="/assets/js/58.65b856f8.js"><link rel="prefetch" href="/assets/js/59.6a97c2b7.js"><link rel="prefetch" href="/assets/js/6.34df74c1.js"><link rel="prefetch" href="/assets/js/60.f78b3bf5.js"><link rel="prefetch" href="/assets/js/61.bee131bd.js"><link rel="prefetch" href="/assets/js/63.7055d872.js"><link rel="prefetch" href="/assets/js/64.d894c341.js"><link rel="prefetch" href="/assets/js/65.b39cadbd.js"><link rel="prefetch" href="/assets/js/66.7a13fc1f.js"><link rel="prefetch" href="/assets/js/67.a6766c4f.js"><link rel="prefetch" href="/assets/js/68.80cf9177.js"><link rel="prefetch" href="/assets/js/69.8ca05e24.js"><link rel="prefetch" href="/assets/js/7.2861f040.js"><link rel="prefetch" href="/assets/js/70.5802ac79.js"><link rel="prefetch" href="/assets/js/71.a8629828.js"><link rel="prefetch" href="/assets/js/72.3b93f7e3.js"><link rel="prefetch" href="/assets/js/73.c8c6e94d.js"><link rel="prefetch" href="/assets/js/74.dbeef2ae.js"><link rel="prefetch" href="/assets/js/75.a71f1c86.js"><link rel="prefetch" href="/assets/js/76.8ea1e96d.js"><link rel="prefetch" href="/assets/js/77.53f0b3f9.js"><link rel="prefetch" href="/assets/js/78.a6e06276.js"><link rel="prefetch" href="/assets/js/79.d7641e2b.js"><link rel="prefetch" href="/assets/js/8.2e921966.js"><link rel="prefetch" href="/assets/js/80.ea6354e1.js"><link rel="prefetch" href="/assets/js/81.a9b14e4a.js"><link rel="prefetch" href="/assets/js/82.1634e735.js"><link rel="prefetch" href="/assets/js/83.0cf5ca64.js"><link rel="prefetch" href="/assets/js/84.a70476ff.js"><link rel="prefetch" href="/assets/js/85.d2b36360.js"><link rel="prefetch" href="/assets/js/86.251249e0.js"><link rel="prefetch" href="/assets/js/87.7f2a1a00.js"><link rel="prefetch" href="/assets/js/88.911418c4.js"><link rel="prefetch" href="/assets/js/89.23d86aa2.js"><link rel="prefetch" href="/assets/js/9.f375de0b.js"><link rel="prefetch" href="/assets/js/90.7a69da44.js"><link rel="prefetch" href="/assets/js/91.acb56149.js"><link rel="prefetch" href="/assets/js/92.8b6fb89a.js"><link rel="prefetch" href="/assets/js/93.01d50793.js"><link rel="prefetch" href="/assets/js/94.e6a5de4e.js"><link rel="prefetch" href="/assets/js/95.5ddea806.js"><link rel="prefetch" href="/assets/js/96.9ce28405.js"><link rel="prefetch" href="/assets/js/97.f82294e4.js"><link rel="prefetch" href="/assets/js/98.27393bcb.js"><link rel="prefetch" href="/assets/js/99.b851e6bb.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.b6901552.js">
    <link rel="stylesheet" href="/assets/css/0.styles.232103a7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">fanthus's blog </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/tag/" class="nav-link">Tags</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">fanthus's blog </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">Tags</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        CoreData 学习笔记三+多Context使用介绍
      </h1> <div class="post-meta"><!----> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2022-11-24T17:59:21.000Z">
      Thu Nov 24 2022
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-42ccfcd5><a href="/tag/CoreData" data-v-42ccfcd5><span data-v-42ccfcd5>CoreData</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/tag/iOS" data-v-42ccfcd5><span data-v-42ccfcd5>iOS</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/tag/macOS" data-v-42ccfcd5><span data-v-42ccfcd5>macOS</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><p>这篇文章主要是介绍如何在 CoreData 中使用多个 Context（本文中提到的 Context 都指的是 NSManagedContext）</p> <h2 id="多-context-基础概念"><a href="#多-context-基础概念" class="header-anchor">#</a> 多 Context 基础概念</h2> <p>CoreData 并不是线程安全的，如果不额外创建线程的话 CoreData 就是一直在主线程运行的。但是有一些情况是需要额外创建线程去进行 CoreData 操作。这时候就要格外注意 <code>NSManagedObject</code>, <code>NSManagedObjectContext</code> 和 <code>NSPersistentStoreCoordinator</code> 这些类并不是线程安全的，对这些类的实例的操作应该只在创建这些实例的线程上下文中去进行。所以在多线程(Concurrency)和多个 Context 操作我理解是同一个话题。</p> <p>CoreData 中 Context 有两种并行模式：</p> <ul><li><code>NSMainQueueConcurrencyType</code></li> <li><code>NSPrivateQueueConcurrencyType</code></li></ul> <p><code>NSMainQueueConcurrencyType</code>  是应用主线程中 Context 用的模式，我们应用刚创建好的时候系统帮我们生成的 <code>persistentContainer.viewContext</code> 就是主线程应用模式，它是在主线程创建的。</p> <p><code>NSPrivateQueueConcurrencyType</code> 是其他队列创建初始化，并且只能在创建它的那个队列中使用。当 Context 创建好之后，关联的队列则是由 Context 去进行管理，所以我们只能通过 Context 的 <code>performBlock:</code> 以及 <code>performBlockAndWait:</code> 方法去进行相关的操作。</p> <blockquote><p>线程和队列是有区别的，为了方便理解，这里其他队列可以简单理解为其他线程，多说一句，苹果官方的说法是主线程中只有主队列，其实并不是这样的，主线程中还有其他队列，但是如果顺着苹果官方的说法的话，那其他队列就是非主线程的队列了。</p></blockquote> <h2 id="多-context-使用-demo"><a href="#多-context-使用-demo" class="header-anchor">#</a> 多 Context 使用 Demo</h2> <p>下面是一个多 Context 操作的 demo:</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token comment">//1. 拿到主队列对应的 Context</span>
<span class="token comment">//2. 创建私有队列对应的 Context</span>
<span class="token comment">//3. 将私有队列对应的 Context 的 parent 设置为主队列的 Context</span>
<span class="token comment">//4. 在私有队列进行数据操作</span>
    <span class="token comment">//4.1 私有 Context 进行 save(), commit 到 parent context</span>
    <span class="token comment">//4.2 parent context 再次进行 save() 保存到本地</span>
<span class="token keyword">let</span> context <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UIApplication</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span>delegate <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">AppDelegate</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>persistentContainer<span class="token punctuation">.</span>viewContext
<span class="token keyword">let</span> privateContext <span class="token operator">=</span> <span class="token class-name">NSManagedObjectContext</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>concurrencyType<span class="token punctuation">:</span> <span class="token punctuation">.</span>privateQueueConcurrencyType<span class="token punctuation">)</span>
privateContext<span class="token punctuation">.</span>parent <span class="token operator">=</span> context
privateContext<span class="token punctuation">.</span>perform <span class="token punctuation">{</span> <span class="token punctuation">[</span><span class="token keyword">weak</span> <span class="token keyword">self</span><span class="token punctuation">]</span> <span class="token keyword">in</span>
    <span class="token keyword">guard</span> <span class="token keyword">let</span> wself <span class="token operator">=</span> <span class="token keyword">self</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> pstudent <span class="token operator">=</span> <span class="token class-name">Book</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>context<span class="token punctuation">:</span> privateContext<span class="token punctuation">)</span>
        pstudent<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token function">UUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>uuidString
        pstudent<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;private_book&quot;</span></span>
        <span class="token keyword">try</span> privateContext<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        wself<span class="token punctuation">.</span>coreDataContext<span class="token punctuation">.</span>perform <span class="token punctuation">{</span>
            <span class="token keyword">try</span><span class="token operator">?</span> context<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;private error </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">error</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面 Demo 的说明</p> <ol><li><p>privateContext 直接创建通过 <code>init(concurrencyType:)</code> 的方式创建，并且需要将其 parentContext 指向主线程中的 context。这是方便后续将改动提交到主 Context 中。</p></li> <li><p>在 perform: 的回调里打断点，可以看到是在非主线程中执行的。图中代码有问题，context.save() 方法没有包一下，看官请留意，下面会说到这个问题。</p> <p><img src="/assets/img/coredata_3.85871744.png" alt="coredata"></p></li> <li><p>在 <a href="http://privateContext.save" target="_blank" rel="noopener noreferrer">privateContext.save<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>() 之后，数据其实并没有保存到数据库，还需要调用主线程 Context 的 save 方法。可以看 save 方法的说明，其实就是将 NSManagedObjects 注册到了 Parent Context 中去了，所以还需要外面的主 Context 重新 save 一下。</p> <blockquote><p><code>save</code> API
<strong>summary</strong>: Attempts to commit unsaved changes to <strong>registered objects to the context’s parent store.</strong><br> <strong>discussion</strong>: If a context’s parent store is a persistent store coordinator, then changes are committed to the external store. If a context’s parent store is another managed object context, then save() only updates managed objects in that parent store. To commit changes to the external store, you must save changes in the chain of contexts up to and including the context whose parent is the persistent store coordinator.</p></blockquote></li> <li><p>调用 context.save 的时候要放在 context 的上下文中去，所以上面demo里用 context.performBlock 包了一下 context 的 save 方法，否则就会崩溃。<strong>在启动参数上添加调试参数 <code>-com.apple.CoreData.ConcurrencyDebug 1</code> 就能提前发现这个问题。</strong></p></li></ol> <h2 id="多-context-数据同步"><a href="#多-context-数据同步" class="header-anchor">#</a> 多 Context 数据同步</h2> <p>多 Context 同步涉及的问题是当在 ContextA 中改了 StudentA 的名字，我在 ContextB 中也修改了 StudentA 的名字，我应该采用哪种方式来进行数据同步呢？</p> <p>有两种方式解决</p> <ol><li>当 ContextA 修改的时候，ContextB 会收到数据修改的变化(<code>NSManagedObjectContextDidSaveNotification</code>)，然后 ContextB 进行修改，这样相当于一处修改，到处同步。</li> <li>当 ContextA 修改的时候，ContextB 不进行任何变化，当 ContextB 进行保存的时候再进行冲突处理。</li></ol> <p>感觉方案一的实现会比较繁琐，因为需要在每个 Context 里做类似的工作。这里着重介绍方案二的方案。</p> <h3 id="context-数据冲突解决"><a href="#context-数据冲突解决" class="header-anchor">#</a> Context 数据冲突解决</h3> <p>尝试制造了冲突代码如下</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">let</span> context <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UIApplication</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span>delegate <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">AppDelegate</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>persistentContainer<span class="token punctuation">.</span>viewContext
<span class="token keyword">let</span> backgroundContext <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UIApplication</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span>delegate <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">AppDelegate</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>persistentContainer<span class="token punctuation">.</span><span class="token function">newBackgroundContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> contextStudents <span class="token operator">=</span> <span class="token keyword">try</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">fetchStudents</span><span class="token punctuation">(</span>context<span class="token punctuation">:</span> context<span class="token operator">!</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> bgContextStudents <span class="token operator">=</span> <span class="token keyword">try</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">fetchStudents</span><span class="token punctuation">(</span>context<span class="token punctuation">:</span> backgroundContext<span class="token operator">!</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> tstudents <span class="token operator">=</span> bgContextStudents<span class="token punctuation">,</span> tstudents<span class="token punctuation">.</span>count <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> student <span class="token operator">=</span> tstudents<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        student<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;private_two&quot;</span></span>
        backgroundContext<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;background context save </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation"><span class="token class-name">Thread</span><span class="token punctuation">.</span>current</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
            <span class="token keyword">try</span><span class="token operator">?</span> backgroundContext<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;context access save&quot;</span></span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> tstudents <span class="token operator">=</span> contextStudents<span class="token punctuation">,</span> tstudents<span class="token punctuation">.</span>count <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> student <span class="token operator">=</span> tstudents<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        student<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;private_one&quot;</span></span>
        <span class="token keyword">try</span> context<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;context save </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation"><span class="token class-name">Thread</span><span class="token punctuation">.</span>current</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;outter </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">error</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>执行后报错如下</p> <div class="language-swift extra-class"><pre class="language-swift"><code>context access save
background context save <span class="token operator">&lt;</span><span class="token class-name">NSThread</span><span class="token punctuation">:</span> <span class="token number">0x60000206ddc0</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>number <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">}</span>
outter <span class="token class-name">Error</span> <span class="token class-name">Domain</span><span class="token operator">=</span><span class="token class-name">NSCocoaErrorDomain</span> <span class="token class-name">Code</span><span class="token operator">=</span><span class="token number">133020</span> <span class="token string-literal"><span class="token string">&quot;Could not merge changes.&quot;</span></span> <span class="token class-name">UserInfo</span><span class="token operator">=</span><span class="token punctuation">{</span>conflictList<span class="token operator">=</span><span class="token punctuation">(</span>
    <span class="token string-literal"><span class="token string">&quot;NSMergeConflict (0x60000206dfc0) for NSManagedObject (0x6000016392c0) with objectID '0x88053de7308a3975 &lt;x-coredata://E9C47EDA-B75C-420C-B400-32DD101EA925/Student/p1&gt;' with oldVersion = 26 and newVersion = 27 and old cached row = {\n    age = 0;\n    name = fan;\n    school = \&quot;&lt;null&gt;\&quot;;\n} and new database row = {\n    age = 0;\n    name = \&quot;private_two\&quot;;\n    school = \&quot;&lt;null&gt;\&quot;;\n}&quot;</span></span>
<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">NSExceptionOmitCallstacks</span><span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">}</span>
</code></pre></div><p>符合预期的效果，具体分析如下：</p> <p>在 Context 中执行 fetch 操作时，会对 persistent store 里的状态进行快照，当 Context 执行保存时，会使用快照与 persistent store 进行对比，如果状态不一致，说明 persistent store 在其他地方被更改了，而这个变化并不是当前 Context 造成的，这样就造成了当前 Context 状态的不连续，此时保存就会产生冲突。这是 CoreData 默认的冲突策略。还有很多其他策略，比如 <code>NSRollbackMergePolicy</code> 是放弃 Context 所有变化，并使用 persistent store 的数据替代以及 <code>NSOverwriteMergePolicy</code> 是强制 Context 中的数据覆盖 persistent store 等。</p> <p>如果这时候我们修改合并策略，改为 <code>NSRollbackMergePolicy</code>，则保存后的结果为 private_two。但这儿有一个非常容易出错的点是，我们需要在比较早的时机去设置合并策略，比如在初始化 <code>container.loadPersistentStores</code> 的时候，如果在上面的代码后面直接设置合并策略是不生效的。这个问题困扰了我半天。</p> <p>另外一种可以解决多 Context 中数据冲突的方案是，使用相同 parentContext 的 context 去 merge 的话，就不会发生这样的冲突，比如下面这种</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">let</span> context <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UIApplication</span><span class="token punctuation">.</span>shared<span class="token punctuation">.</span>delegate <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">AppDelegate</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span>persistentContainer<span class="token punctuation">.</span>viewContext
context<span class="token operator">?</span><span class="token punctuation">.</span>mergePolicy <span class="token operator">=</span> <span class="token class-name">NSSnapshotEventType</span><span class="token punctuation">.</span>rollback
<span class="token keyword">let</span> privateContext1 <span class="token operator">=</span> <span class="token class-name">NSManagedObjectContext</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>concurrencyType<span class="token punctuation">:</span> <span class="token punctuation">.</span>privateQueueConcurrencyType<span class="token punctuation">)</span>
<span class="token keyword">let</span> privateContext2 <span class="token operator">=</span> <span class="token class-name">NSManagedObjectContext</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>concurrencyType<span class="token punctuation">:</span> <span class="token punctuation">.</span>privateQueueConcurrencyType<span class="token punctuation">)</span>
privateContext1<span class="token punctuation">.</span>parent <span class="token operator">=</span> context
privateContext2<span class="token punctuation">.</span>parent <span class="token operator">=</span> context
privateContext1<span class="token punctuation">.</span>perform <span class="token punctuation">{</span> <span class="token punctuation">[</span><span class="token keyword">weak</span> <span class="token keyword">self</span><span class="token punctuation">]</span> <span class="token keyword">in</span>
    <span class="token keyword">guard</span> <span class="token keyword">let</span> wself <span class="token operator">=</span> <span class="token keyword">self</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> students <span class="token operator">=</span> <span class="token keyword">try</span> wself<span class="token punctuation">.</span><span class="token function">fetchStudents</span><span class="token punctuation">(</span>context<span class="token punctuation">:</span> privateContext1<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> tstudents <span class="token operator">=</span> students<span class="token punctuation">,</span> tstudents<span class="token punctuation">.</span>count <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> student <span class="token operator">=</span> tstudents<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            student<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;private_one&quot;</span></span>
            <span class="token keyword">try</span> privateContext1<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">try</span> context<span class="token operator">?</span><span class="token punctuation">.</span>performAndWait <span class="token punctuation">{</span>
                <span class="token keyword">try</span> context<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;private context one error </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">error</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

privateContext2<span class="token punctuation">.</span>perform <span class="token punctuation">{</span> <span class="token punctuation">[</span><span class="token keyword">weak</span> <span class="token keyword">self</span><span class="token punctuation">]</span> <span class="token keyword">in</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token keyword">guard</span> <span class="token keyword">let</span> wself <span class="token operator">=</span> <span class="token keyword">self</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span>
        <span class="token keyword">let</span> students <span class="token operator">=</span> <span class="token keyword">try</span> wself<span class="token punctuation">.</span><span class="token function">fetchStudents</span><span class="token punctuation">(</span>context<span class="token punctuation">:</span> privateContext2<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> tstudents <span class="token operator">=</span> students<span class="token punctuation">,</span> tstudents<span class="token punctuation">.</span>count <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> student <span class="token operator">=</span> tstudents<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            student<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;private_two&quot;</span></span>
            <span class="token keyword">try</span> privateContext2<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">try</span> context<span class="token operator">?</span><span class="token punctuation">.</span>performAndWait <span class="token punctuation">{</span>
                <span class="token keyword">try</span> context<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;private context two error </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">error</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>基本上 Multiple Context 相关的内容就差不多这么多，关于冲突的介绍不是很深入但是应该能满足日常开发的需求了，官方文档对冲突的底层机制有更详细的介绍。这里重在给出一些实践相关的文档，因为网上很多文章没有实例，之前学的时候云里雾里的，所以这次也算给自己做个备份，之后又困惑的时候可以回来看看。</p> <p>参考地址</p> <ol><li><a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/CoreData/Concurrency.html" target="_blank" rel="noopener noreferrer">Core Data Programming Guide → Concurrency<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://code.tutsplus.com/tutorials/core-data-from-scratch-concurrency--cms-22131" target="_blank" rel="noopener noreferrer">Core Data from Scratch: Concurrency<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.jianshu.com/p/37ab8f336f76" target="_blank" rel="noopener noreferrer">Core Data: 多线程大量数据同步<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.fatbobman.com/posts/concurrencyOfCoreData/" target="_blank" rel="noopener noreferrer">关于 Core Data 并发编程的几点提示<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ol> <p>相关链接:</p> <ul><li><a href="https://fanthus.github.io/2022/11/08/coredata%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-1/" target="_blank" rel="noopener noreferrer">CoreData学习笔记 1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://fanthus.github.io/2022/11/24/coredata%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-2/" target="_blank" rel="noopener noreferrer">CoreData学习笔记 2<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://fanthus.github.io/2022/11/24/coredata%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-3/" target="_blank" rel="noopener noreferrer">CoreData学习笔记 3<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://fanthus.github.io/2022/11/25/coredata%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-4/" target="_blank" rel="noopener noreferrer">CoreData学习笔记 4<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <!----></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#多-context-基础概念" title="多 Context 基础概念">多 Context 基础概念</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#多-context-使用-demo" title="多 Context 使用 Demo">多 Context 使用 Demo</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#多-context-数据同步" title="多 Context 数据同步">多 Context 数据同步</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#context-数据冲突解决" title="Context 数据冲突解决">Context 数据冲突解决</a></div></div></div></div> <footer class="footer" data-v-3d9deeb8><div class="footer-left-wrap" data-v-3d9deeb8><ul class="contact" data-v-3d9deeb8></ul></div> <div class="footer-right-wrap" data-v-3d9deeb8><ul class="copyright" data-v-3d9deeb8></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5c2aadbb.js" defer></script><script src="/assets/js/29.1acae59f.js" defer></script><script src="/assets/js/3.7fe07bf0.js" defer></script><script src="/assets/js/62.20ab782f.js" defer></script>
  </body>
</html>
