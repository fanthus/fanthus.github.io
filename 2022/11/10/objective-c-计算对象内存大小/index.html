<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Objective-C 计算对象内存大小 | fanthus&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/logo.jpg">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <script async="true" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3512514942188386" crossorigin="anonymous"></script>
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-MEH5F43SVB"></script>
    <script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-MEH5F43SVB');</script>
    <script>console.log("my name is fanthus, hope my blog bring new ideas to you.");</script>
    <meta name="description" content="系统提供了两种计算对象实例内存大小的方式

通过 runtime 提供的 class_getInstanceSize API
通过底层的 malloc_size 方法。

但是这两个 API 可能会返回不同的结果，看下下面的代码预期会发生什么

sizet size = classgetInstanceSize([NSObject class]);
size_t ...">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/0.styles.232103a7.css" as="style"><link rel="preload" href="/assets/js/app.5c2aadbb.js" as="script"><link rel="preload" href="/assets/js/29.1acae59f.js" as="script"><link rel="preload" href="/assets/js/3.7fe07bf0.js" as="script"><link rel="preload" href="/assets/js/99.b851e6bb.js" as="script"><link rel="prefetch" href="/assets/js/10.e6af762e.js"><link rel="prefetch" href="/assets/js/100.67476119.js"><link rel="prefetch" href="/assets/js/101.f5eb858c.js"><link rel="prefetch" href="/assets/js/102.03da866a.js"><link rel="prefetch" href="/assets/js/103.fb86a639.js"><link rel="prefetch" href="/assets/js/104.3cfe1a59.js"><link rel="prefetch" href="/assets/js/105.06df8093.js"><link rel="prefetch" href="/assets/js/106.3b985ff7.js"><link rel="prefetch" href="/assets/js/107.bc3ffbc8.js"><link rel="prefetch" href="/assets/js/108.4b873cd8.js"><link rel="prefetch" href="/assets/js/109.cf2e8bfc.js"><link rel="prefetch" href="/assets/js/11.ec904e86.js"><link rel="prefetch" href="/assets/js/110.d0e1f360.js"><link rel="prefetch" href="/assets/js/111.32710987.js"><link rel="prefetch" href="/assets/js/112.17690a92.js"><link rel="prefetch" href="/assets/js/113.589070d1.js"><link rel="prefetch" href="/assets/js/114.bec863ac.js"><link rel="prefetch" href="/assets/js/115.66decc99.js"><link rel="prefetch" href="/assets/js/116.b3bfe4dc.js"><link rel="prefetch" href="/assets/js/117.75a5a39d.js"><link rel="prefetch" href="/assets/js/118.e0dd863f.js"><link rel="prefetch" href="/assets/js/119.94c2e0bb.js"><link rel="prefetch" href="/assets/js/12.14256cbe.js"><link rel="prefetch" href="/assets/js/120.c8b76def.js"><link rel="prefetch" href="/assets/js/121.dfdfd9b0.js"><link rel="prefetch" href="/assets/js/122.10da6a05.js"><link rel="prefetch" href="/assets/js/123.e9d46721.js"><link rel="prefetch" href="/assets/js/124.577feddf.js"><link rel="prefetch" href="/assets/js/125.8129b423.js"><link rel="prefetch" href="/assets/js/126.c20f17ba.js"><link rel="prefetch" href="/assets/js/127.7e1c5ded.js"><link rel="prefetch" href="/assets/js/128.5d4e17c0.js"><link rel="prefetch" href="/assets/js/129.f1c8af0e.js"><link rel="prefetch" href="/assets/js/13.6af70c38.js"><link rel="prefetch" href="/assets/js/14.95f777b8.js"><link rel="prefetch" href="/assets/js/15.9c1287ff.js"><link rel="prefetch" href="/assets/js/16.a57aacc5.js"><link rel="prefetch" href="/assets/js/17.5c124641.js"><link rel="prefetch" href="/assets/js/18.6db94c74.js"><link rel="prefetch" href="/assets/js/19.60cf2d9c.js"><link rel="prefetch" href="/assets/js/20.08713c1b.js"><link rel="prefetch" href="/assets/js/21.5eadef54.js"><link rel="prefetch" href="/assets/js/22.66422fed.js"><link rel="prefetch" href="/assets/js/23.739fb024.js"><link rel="prefetch" href="/assets/js/24.c76333d1.js"><link rel="prefetch" href="/assets/js/25.8b10e134.js"><link rel="prefetch" href="/assets/js/26.cfba7153.js"><link rel="prefetch" href="/assets/js/27.72eb7481.js"><link rel="prefetch" href="/assets/js/28.6dcef05c.js"><link rel="prefetch" href="/assets/js/30.2b7c71b4.js"><link rel="prefetch" href="/assets/js/31.5ca92641.js"><link rel="prefetch" href="/assets/js/32.8daba902.js"><link rel="prefetch" href="/assets/js/33.6edbf98d.js"><link rel="prefetch" href="/assets/js/34.84367f88.js"><link rel="prefetch" href="/assets/js/35.85b0ec62.js"><link rel="prefetch" href="/assets/js/36.6cf4ed41.js"><link rel="prefetch" href="/assets/js/37.ee892674.js"><link rel="prefetch" href="/assets/js/38.b7997b04.js"><link rel="prefetch" href="/assets/js/39.90e0d74a.js"><link rel="prefetch" href="/assets/js/4.03934060.js"><link rel="prefetch" href="/assets/js/40.dfc8ad6a.js"><link rel="prefetch" href="/assets/js/41.b60c8046.js"><link rel="prefetch" href="/assets/js/42.77c1c836.js"><link rel="prefetch" href="/assets/js/43.c9d4221c.js"><link rel="prefetch" href="/assets/js/44.6348d9cc.js"><link rel="prefetch" href="/assets/js/45.126bc7fe.js"><link rel="prefetch" href="/assets/js/46.4a3e70e0.js"><link rel="prefetch" href="/assets/js/47.67a75c47.js"><link rel="prefetch" href="/assets/js/48.83f0f7f0.js"><link rel="prefetch" href="/assets/js/49.f7dc76c9.js"><link rel="prefetch" href="/assets/js/5.543a8f29.js"><link rel="prefetch" href="/assets/js/50.e7cc6057.js"><link rel="prefetch" href="/assets/js/51.adabfc4f.js"><link rel="prefetch" href="/assets/js/52.e28c8d20.js"><link rel="prefetch" href="/assets/js/53.13d2e30c.js"><link rel="prefetch" href="/assets/js/54.c393a991.js"><link rel="prefetch" href="/assets/js/55.460bb0db.js"><link rel="prefetch" href="/assets/js/56.2d1300fd.js"><link rel="prefetch" href="/assets/js/57.6ea9c916.js"><link rel="prefetch" href="/assets/js/58.65b856f8.js"><link rel="prefetch" href="/assets/js/59.6a97c2b7.js"><link rel="prefetch" href="/assets/js/6.34df74c1.js"><link rel="prefetch" href="/assets/js/60.f78b3bf5.js"><link rel="prefetch" href="/assets/js/61.bee131bd.js"><link rel="prefetch" href="/assets/js/62.20ab782f.js"><link rel="prefetch" href="/assets/js/63.7055d872.js"><link rel="prefetch" href="/assets/js/64.d894c341.js"><link rel="prefetch" href="/assets/js/65.b39cadbd.js"><link rel="prefetch" href="/assets/js/66.7a13fc1f.js"><link rel="prefetch" href="/assets/js/67.a6766c4f.js"><link rel="prefetch" href="/assets/js/68.80cf9177.js"><link rel="prefetch" href="/assets/js/69.8ca05e24.js"><link rel="prefetch" href="/assets/js/7.2861f040.js"><link rel="prefetch" href="/assets/js/70.5802ac79.js"><link rel="prefetch" href="/assets/js/71.a8629828.js"><link rel="prefetch" href="/assets/js/72.3b93f7e3.js"><link rel="prefetch" href="/assets/js/73.c8c6e94d.js"><link rel="prefetch" href="/assets/js/74.dbeef2ae.js"><link rel="prefetch" href="/assets/js/75.a71f1c86.js"><link rel="prefetch" href="/assets/js/76.8ea1e96d.js"><link rel="prefetch" href="/assets/js/77.53f0b3f9.js"><link rel="prefetch" href="/assets/js/78.a6e06276.js"><link rel="prefetch" href="/assets/js/79.d7641e2b.js"><link rel="prefetch" href="/assets/js/8.2e921966.js"><link rel="prefetch" href="/assets/js/80.ea6354e1.js"><link rel="prefetch" href="/assets/js/81.a9b14e4a.js"><link rel="prefetch" href="/assets/js/82.1634e735.js"><link rel="prefetch" href="/assets/js/83.0cf5ca64.js"><link rel="prefetch" href="/assets/js/84.a70476ff.js"><link rel="prefetch" href="/assets/js/85.d2b36360.js"><link rel="prefetch" href="/assets/js/86.251249e0.js"><link rel="prefetch" href="/assets/js/87.7f2a1a00.js"><link rel="prefetch" href="/assets/js/88.911418c4.js"><link rel="prefetch" href="/assets/js/89.23d86aa2.js"><link rel="prefetch" href="/assets/js/9.f375de0b.js"><link rel="prefetch" href="/assets/js/90.7a69da44.js"><link rel="prefetch" href="/assets/js/91.acb56149.js"><link rel="prefetch" href="/assets/js/92.8b6fb89a.js"><link rel="prefetch" href="/assets/js/93.01d50793.js"><link rel="prefetch" href="/assets/js/94.e6a5de4e.js"><link rel="prefetch" href="/assets/js/95.5ddea806.js"><link rel="prefetch" href="/assets/js/96.9ce28405.js"><link rel="prefetch" href="/assets/js/97.f82294e4.js"><link rel="prefetch" href="/assets/js/98.27393bcb.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.b6901552.js">
    <link rel="stylesheet" href="/assets/css/0.styles.232103a7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">fanthus's blog </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/tag/" class="nav-link">Tags</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">fanthus's blog </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">Tags</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        Objective-C 计算对象内存大小
      </h1> <div class="post-meta"><!----> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2022-11-10T10:54:13.000Z">
      Thu Nov 10 2022
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-42ccfcd5><a href="/tag/Objective-C" data-v-42ccfcd5><span data-v-42ccfcd5>Objective-C</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><p>系统提供了两种计算对象实例内存大小的方式</p> <ol><li>通过 runtime 提供的 <code>class_getInstanceSize</code> API</li> <li>通过底层的 <code>malloc_size</code> 方法。</li></ol> <p>但是这两个 API 可能会返回不同的结果，看下下面的代码预期会发生什么</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token class-name">size_t</span> size <span class="token operator">=</span> <span class="token function">class_getInstanceSize</span><span class="token punctuation">(</span><span class="token punctuation">[</span>NSObject class<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">size_t</span> msize <span class="token operator">=</span> <span class="token function">malloc_size</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__bridge <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>NSObject alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%zu\n&quot;</span><span class="token punctuation">,</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%zu\n&quot;</span><span class="token punctuation">,</span> msize<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>我们知道 NSObject 的成员变量仅仅是包含一个8字节的 isa 指针，所以预期结果是，两个 API 返回的结果都是 8 字节。事实上 <code>malloc_size</code> API 返回的结果是 16 字节。</p> <p>为什么？</p> <p><strong>我们看下 <code>class_getInstanceSize</code> API 的实现</strong></p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">WORD_MASK</span> <span class="token expression"><span class="token number">7UL</span></span></span>
<span class="token class-name">size_t</span> <span class="token function">class_getInstanceSize</span><span class="token punctuation">(</span>Class cls<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cls<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> cls<span class="token operator">-&gt;</span><span class="token function">alignedInstanceSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">uint32_t</span> <span class="token function">alignedInstanceSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">word_align</span><span class="token punctuation">(</span><span class="token function">unalignedInstanceSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token class-name">uint32_t</span> <span class="token function">word_align</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>x <span class="token operator">+</span> WORD_MASK<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span>WORD_MASK<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">uint32_t</span> <span class="token function">unalignedInstanceSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">ro</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>instanceSize<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>先获取未对齐的实例大小（OC 编译后实例的内存大小布局就已经确定了），然后将实例大小进行字对齐操作（64 位系统的按照 8 字节对齐），最终得到的大小就是 <code>class_getInstanceSize</code> 的值。这种计算方式其实并不需要系统真正的分配对象，而是在编译期就能拿到编译后的类实例所占用的内存大小。</p> <p>在上面的例子里面 isa 是 8 个字节，对齐后依然是 8 字节，所以 <code>class_getInstanceSize</code> 返回 8 字节没有问题。</p> <p><strong>再看 <code>malloc_size</code> 为什么返回 16 字节？</strong></p> <p><code>malloc_size</code> API 的介绍如下，它是返回系统分配给指定指针指向内存的内存块的大小。</p> <blockquote><p>The <code>malloc_size()</code> function returns the size of the memory block that
backs the allocation pointed to by ptr.  The memory block size is always
at least as large as the allocation it backs, and may be larger.</p></blockquote> <p>但是在 iOS 在分配内存的时候，最小分配的颗粒度是 16 字节，参考官方文档 <a href="https://developer.apple.com/library/archive/documentation/Performance/Conceptual/ManagingMemory/Articles/MemoryAlloc.html" target="_blank" rel="noopener noreferrer">Tips for Allocating Memory<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <blockquote><p>When allocating any small blocks of memory, remember that the granularity for blocks allocated by the malloc library is 16 bytes. <strong>Thus, the smallest block of memory you can allocate is 16 bytes and any blocks larger than that are a multiple of 16</strong>. For example, if you call malloc and ask for 4 bytes, it returns a block whose size is 16 bytes; if you request 24 bytes, it returns a block whose size is 32 bytes. Because of this granularity, you should design your data structures carefully and try to make them multiples of 16 bytes whenever possible.</p></blockquote> <p>任何小于 16 字节的内存会按照最小颗粒度 16 字节进行大小分配。所以这就是在运行时分配内存的时候，尽管 NSObject 实例只占用 8 个字节，但是也要按照 16 字节分配的原因。</p> <p><strong>下面这个例子中预期的输出结果是什么？</strong></p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token keyword">@interface</span> Person <span class="token punctuation">:</span> NSObject
<span class="token keyword">@property</span><span class="token punctuation">(</span>nonatomic<span class="token punctuation">)</span> NSString <span class="token operator">*</span>name<span class="token punctuation">;</span>
<span class="token keyword">@end</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">@</span>autoreleasepool <span class="token punctuation">{</span>
        size_t isize <span class="token operator">=</span> <span class="token function">class_getInstanceSize</span><span class="token punctuation">(</span><span class="token punctuation">[</span>Person class<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;class_getInstanceSize %zu&quot;</span><span class="token punctuation">,</span>isize<span class="token punctuation">)</span><span class="token punctuation">;</span>
				Person <span class="token operator">*</span>person <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>Person alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
        size_t msize <span class="token operator">=</span> <span class="token function">malloc_size</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__bridge <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;malloc_size %zu&quot;</span><span class="token punctuation">,</span>msize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过 <code>class_getInstanceSize</code> API 计算的时候，还是按照编译后的成员变量大小占用来计算， <code>Person</code> 类有 <code>isa</code> 指针成员变量以及 <code>NSString</code> 指针。两个指针分别占用 8 个字节，所以输出结果是 16 字节。</p> <p>再看  <code>malloc_size</code> API 输出的结果也是 16 个字节。可能会疑惑刚从说的分配内存不是按照最小颗粒度是 16 字节分配吗？为啥一个 <code>isa</code> 指针分配是 16 字节，多了一个 <code>NSString</code> 指针还是 16 字节。</p> <p>我认为这里涉及到内存对齐的概念，即两个指针都占用 8 个字节，而最小颗粒度 16 字节能容纳下来两个指针的大小。所以系统没有必要再额外分配多余的内存给成员变量。</p> <p>如果将 Person 中的 NSString 替换为占用 8 字节的 int 类型，结果如何呢？</p> <div class="language-objectivec extra-class"><pre class="language-objectivec"><code><span class="token keyword">@interface</span> Person <span class="token punctuation">:</span> NSObject
<span class="token keyword">@property</span><span class="token punctuation">(</span>nonatomic<span class="token punctuation">)</span> <span class="token keyword">int</span> a<span class="token punctuation">;</span>
<span class="token keyword">@end</span>
</code></pre></div><p>通过 <code>class_getInstanceSize</code> API 计算得到的结果是 16 字节，这里依然是考虑了内存对齐，如果不考虑内存对齐，Person 实例实际占用的内存是 isa(8字节)+ int(4字节) = 12 字节大小，但是因为内存对齐的缘故，实际计算结果是 16 字节。</p> <p>所以其实不论是 <code>class_getInstanceSize</code> 还是 <code>malloc_size</code> 在实际计算内存的时候都会考虑到内存对齐的操作。</p> <p>参考地址:</p> <ol><li><a href="https://www.jianshu.com/p/abe6f927df8a" target="_blank" rel="noopener noreferrer">iOS底层探索之内存对齐和calloc<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://developer.apple.com/library/archive/documentation/Performance/Conceptual/ManagingMemory/Articles/MemoryAlloc.html" target="_blank" rel="noopener noreferrer">Tips for Allocating Memory<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://developer.apple.com/library/archive/documentation/System/Conceptual/ManPages_iPhoneOS/man3/malloc_size.3.html" target="_blank" rel="noopener noreferrer">malloc_size API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://fanthus.github.io/2023/02/07/swift-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/" target="_blank" rel="noopener noreferrer">Swift 内存模型<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ol></div> <footer><!----> <hr> <!----></footer></article> <!----></div></div> <footer class="footer" data-v-3d9deeb8><div class="footer-left-wrap" data-v-3d9deeb8><ul class="contact" data-v-3d9deeb8></ul></div> <div class="footer-right-wrap" data-v-3d9deeb8><ul class="copyright" data-v-3d9deeb8></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5c2aadbb.js" defer></script><script src="/assets/js/29.1acae59f.js" defer></script><script src="/assets/js/3.7fe07bf0.js" defer></script><script src="/assets/js/99.b851e6bb.js" defer></script>
  </body>
</html>
